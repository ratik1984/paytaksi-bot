<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PayTaksi — Driver</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="config.js"></script>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0d12;color:#e8eefc}
header{padding:12px 14px;background:#101525;position:sticky;top:0;z-index:5;border-bottom:1px solid #1f2a44}
h1{font-size:16px;margin:0}
.container{padding:12px 14px;max-width:980px;margin:0 auto}
.card{background:#101525;border:1px solid #1f2a44;border-radius:14px;padding:12px;margin:10px 0}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1;min-width:220px}
input,select,button,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #2a3960;background:#0b0d12;color:#e8eefc}
button{cursor:pointer;background:#2b5cff;border-color:#2b5cff}
button.secondary{background:#17203a;border-color:#2a3960}
small{opacity:.8}
#map{height:360px;border-radius:14px;overflow:hidden;border:1px solid #1f2a44}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#17203a;border:1px solid #2a3960;font-size:12px}
hr{border:none;border-top:1px solid #1f2a44;margin:10px 0}
</style>
</head>
<body>
<header>
  <h1>PayTaksi — Sürücü</h1>
  <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
    <span class="badge" id="who">…</span>
    <span class="badge" id="status">Status: -</span>
    <span class="badge" id="wallet">Balans: -</span>
    <span class="badge" id="rating">Reytinq: -</span>
  </div>
</header>

<div class="container">
  <div class="card">
    <div class="row">
      <div><label>Maşın modeli</label><input id="car" placeholder="Prius"/></div>
      <div><label>Nömrə</label><input id="plate" placeholder="90-XX-123"/></div>
      <div><label>&nbsp;</label><button id="save">Yadda saxla</button></div>
    </div>
    <div class="row">
      <div><button id="goOnline">Online ol</button></div>
      <div><button id="goOffline" class="secondary">Offline ol</button></div>
      <div><button id="sendGps" class="secondary">GPS göndər</button></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;font-size:14px">Gələn sifariş</h3>
    <div id="offerBox" class="badge">Hələ sifariş yoxdur</div>
    <div class="row" style="margin-top:10px">
      <div><button id="accept" disabled>Qəbul et</button></div>
      <div><button id="reject" class="secondary" disabled>Rədd et</button></div>
    </div>
    <hr/>
    <div class="row">
      <div><button id="arrived" class="secondary" disabled>Çatdım</button></div>
      <div><button id="start" class="secondary" disabled>Başlat</button></div>
      <div><button id="finish" disabled>Bitir</button></div>
    </div>
    <div style="margin-top:10px">
      <label>Yekun məsafə (km)</label>
      <input id="finalKm" type="number" step="0.1" value="5.0"/>
    </div>
  </div>

  <div class="card"><div id="map"></div></div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;font-size:14px">Qazanc</h3>
    <div class="row">
      <div><button class="secondary" onclick="loadE('day')">Gün</button></div>
      <div><button class="secondary" onclick="loadE('week')">Həftə</button></div>
      <div><button class="secondary" onclick="loadE('month')">Ay</button></div>
    </div>
    <div id="earn" class="badge" style="margin-top:10px">-</div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;font-size:14px">Balans artırma (Manual)</h3>
    <div class="row">
      <div><label>Məbləğ (AZN)</label><input id="topAmt" type="number" step="0.01" value="10"/></div>
      <div><label>Metod</label>
        <select id="topMethod"><option value="CARD_TO_CARD">Kart to Kart</option><option value="M10">m10</option></select>
      </div>
      <div><label>Çek / TX id</label><input id="topProof" placeholder="TX12345"/></div>
    </div>
    <button id="topReq">Sorğu göndər</button>
    <small>Admin təsdiqləyəndən sonra balans artacaq.</small>
  </div>

  <div class="card"><h3 style="margin:0 0 10px 0;font-size:14px">Log</h3>
    <div id="log" style="white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;font-size:12px;opacity:.9"></div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const tg = window.Telegram?.WebApp; tg?.ready();
const cfg = window.APP_CONFIG;
const logEl=document.getElementById("log");
const log=(m)=>logEl.textContent=`[${new Date().toLocaleTimeString()}] ${m}\n`+logEl.textContent;

const me={ telegram_id:(tg?.initDataUnsafe?.user?.id||"0").toString() };
document.getElementById("who").textContent="TG: "+me.telegram_id;

async function api(path, method="GET", body=null){
  const res=await fetch(cfg.BACKEND_BASE_URL+path,{
    method,
    headers:{"Content-Type":"application/json","x-api-key":cfg.API_KEY,"x-telegram-id":me.telegram_id},
    body: body?JSON.stringify(body):null
  });
  const data=await res.json();
  if(!res.ok) throw new Error(data.error||"API error");
  return data;
}

let driver=null, activeTripId=null, lastOffer=null;

const map=L.map('map').setView([40.4093,49.8671],12);
const token=cfg.MAPBOX_TOKEN;
const tileUrl=token?`https://api.mapbox.com/styles/v1/mapbox/streets-v12/tiles/{z}/{x}/{y}?access_token=${token}`:`https://tile.openstreetmap.org/{z}/{x}/{y}.png`;
L.tileLayer(tileUrl,{maxZoom:19}).addTo(map);
let myMarker, pickupMarker, dropMarker;

function updateBadges(){
  if(!driver) return;
  document.getElementById("status").textContent="Status: "+driver.status;
  document.getElementById("wallet").textContent="Balans: "+Number(driver.wallet_balance).toFixed(2);
  document.getElementById("rating").textContent="Reytinq: "+Number(driver.rating).toFixed(2);
}

api("/api/register","POST",{role:"driver"}).then(r=>{driver=r.driver; updateBadges(); log("Driver id="+driver.id);}).catch(e=>log("Register error: "+e.message));

document.getElementById("save").onclick=async ()=>{
  try{
    const r=await api("/api/driver/profile","POST",{car_model:document.getElementById("car").value, plate:document.getElementById("plate").value});
    driver=r.driver; log("Profile saved");
  }catch(e){alert(e.message);}
};

document.getElementById("goOnline").onclick=async ()=>{
  try{ const r=await api("/api/driver/status","POST",{status:"online"}); driver=r.driver; updateBadges(); log("Online"); }
  catch(e){alert(e.message);}
};
document.getElementById("goOffline").onclick=async ()=>{
  try{ const r=await api("/api/driver/status","POST",{status:"offline"}); driver=r.driver; updateBadges(); log("Offline"); }
  catch(e){alert(e.message);}
};

function gpsOnce(cb){
  if(!navigator.geolocation) return alert("GPS yoxdur");
  navigator.geolocation.getCurrentPosition((pos)=>{
    cb({lat:pos.coords.latitude,lng:pos.coords.longitude,speed:pos.coords.speed||0});
  }, (err)=>alert(err.message), {enableHighAccuracy:true, timeout:8000});
}

document.getElementById("sendGps").onclick=()=>{
  gpsOnce(({lat,lng,speed})=>{
    socket.emit("driver_location",{lat,lng,speed});
    if(myMarker) myMarker.remove();
    myMarker=L.marker([lat,lng]).addTo(map);
    map.setView([lat,lng],15);
    log("GPS sent");
  });
};

function setOffer(o){
  lastOffer=o;
  const box=document.getElementById("offerBox");
  document.getElementById("accept").disabled=!o;
  document.getElementById("reject").disabled=!o;
  if(!o){ box.textContent="Hələ sifariş yoxdur"; return; }
  box.textContent=`Trip: ${o.trip_id} | ${o.fare_est} AZN | ${o.payment_method}`;
  if(pickupMarker) pickupMarker.remove();
  if(dropMarker) dropMarker.remove();
  pickupMarker=L.marker([o.pickup_lat,o.pickup_lng]).addTo(map);
  dropMarker=L.marker([o.drop_lat,o.drop_lng]).addTo(map);
  map.fitBounds(L.latLngBounds([pickupMarker.getLatLng(), dropMarker.getLatLng()]), {padding:[20,20]});
}

document.getElementById("accept").onclick=async ()=>{
  if(!lastOffer) return;
  try{
    await api("/api/trips/accept","POST",{trip_id:lastOffer.trip_id});
    activeTripId=lastOffer.trip_id;
    setOffer(null);
    log("Accepted "+activeTripId);
    document.getElementById("arrived").disabled=false;
  }catch(e){alert(e.message);}
};
document.getElementById("reject").onclick=async ()=>{
  if(!lastOffer) return;
  try{
    await api("/api/trips/reject","POST",{trip_id:lastOffer.trip_id});
    setOffer(null);
    log("Rejected (rating down)");
    const er=await api("/api/driver/earnings?range=day");
    driver={...driver,...er.driver}; updateBadges();
  }catch(e){alert(e.message);}
};

document.getElementById("arrived").onclick=async ()=>{
  if(!activeTripId) return;
  await api("/api/trips/status","POST",{trip_id:activeTripId,status:"ARRIVED"});
  log("ARRIVED"); document.getElementById("start").disabled=false;
};
document.getElementById("start").onclick=async ()=>{
  if(!activeTripId) return;
  await api("/api/trips/status","POST",{trip_id:activeTripId,status:"STARTED"});
  log("STARTED"); document.getElementById("finish").disabled=false;
};
document.getElementById("finish").onclick=async ()=>{
  if(!activeTripId) return;
  const km=Number(document.getElementById("finalKm").value||0);
  const r=await api("/api/trips/status","POST",{trip_id:activeTripId,status:"COMPLETED",distance_km_final:km});
  log("COMPLETED fare="+r.fare_total+" commission="+r.commission);
  activeTripId=null;
  document.getElementById("arrived").disabled=true;
  document.getElementById("start").disabled=true;
  document.getElementById("finish").disabled=true;
  const er=await api("/api/driver/earnings?range=day");
  driver={...driver,...er.driver}; updateBadges();
};

async function loadE(range){
  const e=await api("/api/driver/earnings?range="+range);
  document.getElementById("earn").textContent=`${range}: trips=${e.trips} gross=${Number(e.gross).toFixed(2)} commission=${Number(e.commission).toFixed(2)} | wallet=${Number(e.driver.wallet_balance).toFixed(2)}`;
}
window.loadE=loadE;

document.getElementById("topReq").onclick=async ()=>{
  try{
    const r=await api("/api/driver/topup/request","POST",{
      amount:Number(document.getElementById("topAmt").value||0),
      method:document.getElementById("topMethod").value,
      proof_text:document.getElementById("topProof").value
    });
    log("Topup request "+r.request_id);
    alert("Sorğu göndərildi. Admin təsdiqləyəndə balans artacaq.");
  }catch(e){alert(e.message);}
};

const socket=io(cfg.BACKEND_BASE_URL,{transports:["websocket","polling"]});
socket.on("connect",()=>{
  log("Socket connected");
  socket.emit("identify",{telegram_id:me.telegram_id,role:"driver"});
  setInterval(()=>{
    if(!driver||driver.status!=="online") return;
    gpsOnce(({lat,lng,speed})=>socket.emit("driver_location",{lat,lng,speed}));
  }, 5000);
});
socket.on("identified",(d)=>{driver=d.driver; updateBadges(); log("Socket identified driver id="+driver.id);});
socket.on("trip_offer",(o)=>{ if(driver&&driver.status!=="online") return; log("Offer "+o.trip_id); setOffer(o); });
socket.on("wallet_update",(u)=>log("Wallet update "+JSON.stringify(u)));
socket.on("trip_update",(u)=>log("Trip update "+JSON.stringify(u)));
</script>
</body></html>
