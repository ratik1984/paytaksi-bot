generator client { provider = "prisma-client-js" }
datasource db { provider = "postgresql" url = env("DATABASE_URL") }

enum Role { PASSENGER DRIVER ADMIN }
enum DriverStatus { PENDING APPROVED REJECTED }
enum OrderStatus { SEARCHING ACCEPTED STARTED FINISHED CANCELED }
enum TopupStatus { PENDING APPROVED REJECTED }

model User {
  id        Int      @id @default(autoincrement())
  tgId      BigInt   @unique
  role      Role
  createdAt DateTime @default(now())
  passenger Passenger?
  driver    Driver?
  admin     Admin?
}

model Passenger {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])
  orders Order[] @relation("PassengerOrders")
}

model Admin {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])
}

model Driver {
  id        Int          @id @default(autoincrement())
  userId    Int          @unique
  user      User         @relation(fields: [userId], references: [id])
  status    DriverStatus @default(PENDING)
  carYear   Int?
  carColor  String?
  balance   Float        @default(0)
  idFrontFileId   String?
  idBackFileId    String?
  dlFrontFileId   String?
  dlBackFileId    String?
  techFrontFileId String?
  techBackFileId  String?
  isOnline  Boolean @default(false)
  lastLat   Float?
  lastLon   Float?
  lastLocAt DateTime?
  orders    Order[] @relation("DriverOrders")
  topups    TopupRequest[]
  broadcasts OrderBroadcast[]
}

model Order {
  id          Int         @id @default(autoincrement())
  status      OrderStatus @default(SEARCHING)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  passengerId Int
  passenger   Passenger   @relation("PassengerOrders", fields: [passengerId], references: [id])
  driverId    Int?
  driver      Driver?     @relation("DriverOrders", fields: [driverId], references: [id])
  pickupLat   Float
  pickupLon   Float
  dropLat     Float
  dropLon     Float
  dropAddress String?
  distanceKm  Float
  fare        Float
  commission  Float
}

model OrderBroadcast {
  id        Int      @id @default(autoincrement())
  orderId   Int
  driverId  Int
  sentAt    DateTime @default(now())
  messageId Int?
  order  Order  @relation(fields: [orderId], references: [id])
  driver Driver @relation(fields: [driverId], references: [id])
  @@unique([orderId, driverId])
}

model TopupRequest {
  id          Int         @id @default(autoincrement())
  driverId    Int
  driver      Driver      @relation(fields: [driverId], references: [id])
  amount      Float
  method      String
  proofFileId String?
  status      TopupStatus @default(PENDING)
  createdAt   DateTime    @default(now())
  decidedAt   DateTime?
}

model Setting { key String @id value String }

model AuditLog {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  actorTgId BigInt?
  action    String
  meta      String?
}
