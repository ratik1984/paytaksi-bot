<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi WebApp</title>

  <!-- Telegram WebApp SDK (mütləq) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b1220;color:#fff}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{background:#121a2a;border:1px solid #23314d;border-radius:16px;padding:16px;margin:12px 0}
    .muted{opacity:.75}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #2c3a58;background:#0b1220;color:#fff}
    button{width:100%;padding:14px;border-radius:14px;border:0;background:#2f6bff;color:#fff;font-weight:700}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#1c2942;border:1px solid #2c3a58}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h2 style="margin:0">PayTaksi</h2>
      <span class="pill" id="fromPill">from: ?</span>
      <span class="pill" id="idPill">TG ID: unknown</span>
    </div>

    <div class="card" id="warnCard">
      <b>Diqqət:</b> Bu səhifə Telegram WebApp içində açılmasa Telegram user məlumatı gəlmir.
      <div class="muted" style="margin-top:8px">
        Normal istifadə: botdan “WebApp” düyməsi ilə aç.
      </div>
    </div>

    <div class="card" id="testBlock">
      <h3 style="margin:0 0 10px 0">Test üçün Telegram ID daxil et</h3>
      <div class="muted" style="margin-bottom:10px">Telegram daxilində açanda buna ehtiyac yoxdur.</div>
      <div class="row">
        <div>
          <div class="muted" style="margin-bottom:6px">Telegram ID</div>
          <input id="manualId" placeholder="məs: 123456789" />
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Username (optional)</div>
          <input id="manualUsername" placeholder="məs: ratik1984" />
        </div>
      </div>
      <div style="height:12px"></div>
      <button id="saveBtn">Yadda saxla</button>
      <div class="muted" style="margin-top:10px">
        Alternativ: URL-a belə əlavə edə bilərsən: <code>?from=driver&id=123456789&username=ratik1984</code>
      </div>
    </div>

    <div class="card">
      <div class="muted">Sərnişin: Yerini tap, ünvan yaz, OSRM ilə məsafə hesablanır, qiymət çıxır.</div>
      <div style="height:10px"></div>
      <div class="row">
        <div><input placeholder="Pick-up (Yer)" /></div>
        <div><input placeholder="Drop-off (Gedəcəyin yer)" /></div>
      </div>
    </div>

    <div class="card">
      <div class="muted">Debug</div>
      <pre id="debug" style="white-space:pre-wrap;word-break:break-word;margin:8px 0 0 0"></pre>
    </div>
  </div>

<script>
(function () {
  const params = new URLSearchParams(location.search);
  const from = params.get("from") || "unknown";
  document.getElementById("fromPill").textContent = "from: " + from;

  const debugEl = document.getElementById("debug");
  const idPill = document.getElementById("idPill");
  const warnCard = document.getElementById("warnCard");
  const testBlock = document.getElementById("testBlock");

  function setUser(id, username, source) {
    if (!id) return;
    idPill.textContent = "TG ID: " + id;
    warnCard.style.display = "none";
    testBlock.style.display = "none";
    debugEl.textContent =
      "SOURCE: " + source + "\n" +
      "id: " + id + "\n" +
      "username: " + (username || "-") + "\n" +
      "from: " + from + "\n";
  }

  // 0) URL ilə test (developer)
  const urlId = params.get("id");
  if (urlId) {
    setUser(urlId, params.get("username") || "", "URL query (test)");
    return;
  }

  // 1) Telegram WebApp
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) {
    try {
      tg.ready();
      tg.expand();

      const user = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
      const initData = tg.initData || "";

      debugEl.textContent =
        "tg_present: yes\n" +
        "initData_length: " + initData.length + "\n" +
        "user: " + JSON.stringify(user) + "\n";

      if (user && user.id) {
        setUser(user.id, user.username, "Telegram initDataUnsafe");
        return;
      }
    } catch (e) {
      debugEl.textContent = "Telegram error: " + String(e);
    }
  } else {
    debugEl.textContent = "tg_present: no\n";
  }

  // 2) Əgər Telegramdan gəlmirsə -> local test/manual
  const savedId = localStorage.getItem("pt_tg_id");
  const savedUsername = localStorage.getItem("pt_tg_username");
  if (savedId) setUser(savedId, savedUsername, "localStorage");

  document.getElementById("saveBtn").addEventListener("click", () => {
    const id = (document.getElementById("manualId").value || "").trim();
    const username = (document.getElementById("manualUsername").value || "").trim();
    if (!id) return alert("Telegram ID daxil et");
    localStorage.setItem("pt_tg_id", id);
    localStorage.setItem("pt_tg_username", username);
    setUser(id, username, "manual input");
  });
})();
</script>
</body>
</html>
