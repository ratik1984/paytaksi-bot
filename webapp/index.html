<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b1220;color:#fff}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{background:#121a2a;border:1px solid #23314d;border-radius:16px;padding:16px;margin:12px 0}
    .muted{opacity:.75}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #2c3a58;background:#0b1220;color:#fff}
    button{width:100%;padding:14px;border-radius:14px;border:0;background:#2f6bff;color:#fff;font-weight:700}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#1c2942;border:1px solid #2c3a58}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .danger{border-color:#7a2b2b;background:#1d0f12}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h2 style="margin:0">PayTaksi</h2>
      <span class="pill" id="fromPill">from: ?</span>
      <span class="pill" id="idPill">TG ID: checking…</span>
    </div>

    <div class="card danger" id="errCard" style="display:none">
      <b>Xəta:</b> <span id="errText"></span>
      <div class="muted" style="margin-top:8px">BotFather URL düzgün olmalıdır və serverdə BOT_TOKEN set edilməlidir.</div>
    </div>

    <div class="card" id="okCard" style="display:none">
      <div><b>Verified ✅</b></div>
      <div class="muted" id="userLine"></div>
    </div>

    <div class="card">
      <div class="muted">Ride demo (coords ilə)</div>
      <div style="height:10px"></div>
      <div class="row">
        <div><input id="fromLat" placeholder="from_lat (məs: 40.4093)" /></div>
        <div><input id="fromLng" placeholder="from_lng (məs: 49.8671)" /></div>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <div><input id="toLat" placeholder="to_lat" /></div>
        <div><input id="toLng" placeholder="to_lng" /></div>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <div><input id="fromText" placeholder="Pick-up (text)" /></div>
        <div><input id="toText" placeholder="Drop-off (text)" /></div>
      </div>
      <div style="height:12px"></div>
      <button id="createRideBtn">Ride yarat</button>
    </div>

    <div class="card">
      <div class="muted">Debug</div>
      <pre id="debug" style="white-space:pre-wrap;word-break:break-word;margin:8px 0 0 0"></pre>
    </div>
  </div>

<script>
(async function () {
  const params = new URLSearchParams(location.search);
  const from = params.get("from") || "unknown";
  document.getElementById("fromPill").textContent = "from: " + from;

  const idPill = document.getElementById("idPill");
  const debugEl = document.getElementById("debug");
  const errCard = document.getElementById("errCard");
  const errText = document.getElementById("errText");
  const okCard = document.getElementById("okCard");
  const userLine = document.getElementById("userLine");

  const tg = window.Telegram?.WebApp;
  if (!tg) {
    idPill.textContent = "TG ID: unknown";
    errCard.style.display = "block";
    errText.textContent = "Telegram WebApp tapılmadı (WebApp düyməsi ilə aç).";
    return;
  }

  tg.ready();
  tg.expand();

  const initData = tg.initData || "";
  debugEl.textContent = "initData_length: " + initData.length + "\\n";

  async function api(path, body) {
    const r = await fetch(path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const j = await r.json().catch(() => ({}));
    if (!r.ok || !j.ok) {
      const msg = j.error || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return j;
  }

  // 1) Verify via backend (SECURE)
  let user = null;
  try {
    const j = await api("/api/verify-telegram", { initData });
    user = j.user;
    idPill.textContent = "TG ID: " + user.id;
    okCard.style.display = "block";
    userLine.textContent = (user.username ? "@" + user.username : "no username") + " • " + (user.first_name || "") + " " + (user.last_name || "");
    debugEl.textContent += "verified: yes\\n";
  } catch (e) {
    idPill.textContent = "TG ID: unknown";
    errCard.style.display = "block";
    errText.textContent = String(e.message || e);
    debugEl.textContent += "verified: no\\nerror: " + String(e.message || e) + "\\n";
    return;
  }

  // 2) Ride create demo
  document.getElementById("createRideBtn").addEventListener("click", async () => {
    const payload = {
      initData,
      from_lat: document.getElementById("fromLat").value,
      from_lng: document.getElementById("fromLng").value,
      to_lat: document.getElementById("toLat").value,
      to_lng: document.getElementById("toLng").value,
      from_text: document.getElementById("fromText").value,
      to_text: document.getElementById("toText").value
    };
    try {
      const j = await api("/api/rides", payload);
      alert("Ride created: " + JSON.stringify(j.ride));
    } catch (e) {
      alert("Xəta: " + String(e.message || e));
    }
  });
})();
</script>
</body>
</html>
