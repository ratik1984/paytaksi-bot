<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi - Admin</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:14px}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:12px;margin:10px 0}
    input,button,select{width:100%;padding:10px;border-radius:12px;border:1px solid #d9d9d9;font-size:16px}
    button{border:none;background:#111;color:#fff}
    .muted{color:#666;font-size:13px}
    .item{padding:8px;border:1px dashed #ddd;border-radius:12px;margin:6px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    a{color:inherit}
    img{max-width:100%;border-radius:12px;border:1px solid #eee}
  </style>
</head>
<body>
  <h2>PayTaksi üõ† Admin</h2>
  <div class="muted">MVP: Basic Auth (Admin login: Ratik / 0123456789).</div>

  <div class="card">
    <b>Giri≈ü</b>
    <div class="two">
      <input id="user" placeholder="Admin login" value="Ratik" />
      <input id="pass" placeholder="Admin parol" value="0123456789" />
    </div>
    <button id="btnSave">üîê Saxla</button>
    <div class="muted" id="loginStatus">‚Äî</div>
  </div>

  <div class="card">
    <b>Yekun</b>
    <div id="summary" class="muted">‚Äî</div>
  </div>

  <div class="card">
    <b>S√ºr√ºc√ºl…ôr</b>
    <div id="drivers"></div>
  </div>

  <div class="card">
    <b>Balans artƒ±rma sorƒüularƒ±</b>
    <div id="topups"></div>
  </div>

  <div class="card">
    <b>Sifari≈ül…ôr</b>
    <div id="rides"></div>
  </div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

function authHeader(){
  const u = localStorage.getItem('adm_u') || '';
  const p = localStorage.getItem('adm_p') || '';
  if (!u || !p) return null;
  return 'Basic ' + btoa(u + ':' + p);
}

async function adminApi(path, {method='GET', body=null}={}){
  const ah = authHeader();
  if (!ah) throw new Error('no_auth');
  const res = await fetch(path, {
    method,
    headers: { 'Content-Type':'application/json', 'Authorization': ah },
    body: body ? JSON.stringify(body) : null
  });
  const data = await res.json().catch(()=>({ok:false,error:'bad_json'}));
  if (!res.ok) throw Object.assign(new Error(data.error||'http_error'), { status: res.status, data });
  return data;
}

const loginStatus = document.getElementById('loginStatus');
document.getElementById('btnSave').onclick = ()=>{
  localStorage.setItem('adm_u', document.getElementById('user').value.trim());
  localStorage.setItem('adm_p', document.getElementById('pass').value);
  loginStatus.textContent = 'Saxlandƒ± ‚úÖ';
  refresh();
};

async function refresh(){
  try{
    const s = await adminApi('/api/admin/summary');
    document.getElementById('summary').innerHTML =
      `Pending s√ºr√ºc√º: <b>${s.drivers_pending}</b> ‚Ä¢ Pending topup: <b>${s.topups_pending}</b> ‚Ä¢ Aktiv sifari≈ü: <b>${s.rides_open}</b>`;
  }catch(e){}

  try{
    const d = await adminApi('/api/admin/drivers');
    const box = document.getElementById('drivers');
    box.innerHTML='';
    (d.drivers||[]).forEach((x)=>{
      const div = document.createElement('div');
      div.className='item';
      const docs = (x.documents||[]).map(dd=>`<a href="${dd.file_path}" target="_blank">${dd.doc_type}</a>`).join(' ‚Ä¢ ');
      div.innerHTML = `
        <b>#${x.id}</b> ‚Ä¢ ${x.status} ‚Ä¢ Balans: ${x.balance} AZN<br>
        TG: ${x.first_name||''} (@${x.username||'-'}) ‚Ä¢ tg_id: ${x.tg_id}<br>
        Avto: ${x.car_make||''} ${x.car_model||''} ‚Ä¢ ${x.car_year} ‚Ä¢ ${x.car_color} ‚Ä¢ ${x.plate||''}<br>
        <span class="muted">S…ôn…ôdl…ôr: ${docs || '-'}</span>
        <div class="three" style="margin-top:8px">
          <button data-s="approved">T…ôsdiql…ô</button>
          <button data-s="rejected">R…ôdd et</button>
          <button data-s="blocked">Blokla</button>
        </div>
      `;
      div.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=>{
          const status = btn.getAttribute('data-s');
          await adminApi('/api/admin/driver_status',{method:'POST', body:{driver_id:x.id, status}});
          refresh();
        };
      });
      box.appendChild(div);
    });
    if (!(d.drivers||[]).length) box.innerHTML='<div class="muted">S√ºr√ºc√º yoxdur.</div>';
  }catch(e){}

  try{
    const t = await adminApi('/api/admin/topups');
    const box = document.getElementById('topups');
    box.innerHTML='';
    (t.topups||[]).forEach((x)=>{
      const div = document.createElement('div');
      div.className='item';
      div.innerHTML = `
        <b>#${x.id}</b> ‚Ä¢ ${x.status}<br>
        S√ºr√ºc√º: ${x.first_name||''} (@${x.username||'-'}) ‚Ä¢ tg_id: ${x.tg_id}<br>
        M…ôbl…ôƒü: <b>${x.amount} AZN</b> ‚Ä¢ Metod: ${x.method}<br>
        Ref: <span class="muted">${x.reference||'-'}</span>
        <div class="two" style="margin-top:8px">
          <button data-a="approve">Approve</button>
          <button data-a="reject">Reject</button>
        </div>
      `;
      div.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=>{
          const action = btn.getAttribute('data-a');
          await adminApi('/api/admin/topup_review',{method:'POST', body:{ topup_id:x.id, action }});
          refresh();
        };
      });
      box.appendChild(div);
    });
    if (!(t.topups||[]).length) box.innerHTML='<div class="muted">Sorƒüu yoxdur.</div>';
  }catch(e){}

  try{
    const r = await adminApi('/api/admin/rides');
    const box = document.getElementById('rides');
    box.innerHTML='';
    (r.rides||[]).forEach((x)=>{
      const div = document.createElement('div');
      div.className='item';
      div.innerHTML = `
        <b>#${x.id}</b> ‚Ä¢ ${x.status}<br>
        S…ôrni≈üin: ${x.passenger_name||''} (tg:${x.passenger_tg_id})<br>
        S√ºr√ºc√º: ${x.driver_name||'-'} (tg:${x.driver_tg_id||'-'})<br>
        ${x.pickup_text||''} ‚Üí ${x.drop_text||''}<br>
        ${Number(x.distance_km).toFixed(2)} km ‚Ä¢ ${x.fare} AZN ‚Ä¢ Komissiya: ${x.commission} AZN
      `;
      box.appendChild(div);
    });
  }catch(e){}
}

(function init(){
  const u = localStorage.getItem('adm_u'); const p = localStorage.getItem('adm_p');
  if (u) document.getElementById('user').value=u;
  if (p) document.getElementById('pass').value=p;
  refresh();
  setInterval(refresh, 6000);
})();
</script>
</body>
</html>
