<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi - S…ôrni≈üin</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="../assets/common.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>

    :root{
      --bg:#ffffff;
      --panel:rgba(255,255,255,.92);
      --text:#0b0f14;
      --muted:#5b6572;
      --line:rgba(0,0,0,.10);
      --accent:#1bb66a;
      --danger:#b00020;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);overflow:hidden}

    /* Map */
    #mapWrap{position:relative;height:62vh;min-height:340px;background:#f3f4f6}
    #map{position:absolute;inset:0}
    .mapBtn{position:absolute;width:46px;height:46px;border-radius:999px;border:1px solid var(--line);background:var(--panel);backdrop-filter: blur(10px);color:var(--text);display:flex;align-items:center;justify-content:center;font-size:20px}
    .mapBtn:active{transform:scale(.98)}
    #btnMenu{left:14px;top:14px}
    #btnCenter{right:14px;top:14px}

    /* Bottom sheet */
    #sheet{position:absolute;left:0;right:0;bottom:0;height:48vh;
      background:var(--panel);
      border-top-left-radius:22px;border-top-right-radius:22px;border-top:1px solid var(--line);
      overflow:hidden;
      box-shadow: 0 -18px 60px rgba(0,0,0,.12);
    }
    #sheetHandle{width:44px;height:5px;border-radius:999px;background:rgba(0,0,0,.20);margin:10px auto 8px auto}
    #sheetInner{height:100%;overflow:auto;padding:0 14px 92px 14px}

    .title{font-weight:900;font-size:22px;margin:6px 2px}
    .muted{color:var(--muted);font-size:13px}
    .card{border:1px solid var(--line);border-radius:18px;padding:12px;margin:10px 0;background:#fff}
    input,button,select{width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);font-size:16px;background:#fff}
    button{border:none;background:var(--accent);color:#08110b;font-weight:900}
    button.secondary{background:#111;color:#fff}
    button.danger{background:var(--danger);color:#fff}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .list{margin-top:8px}
    .item{padding:10px;border:1px solid rgba(0,0,0,.12);border-radius:14px;margin:6px 0;background:#fff}
    .progress{height:8px;border-radius:999px;background:rgba(0,0,0,.08);overflow:hidden}
    .progress > div{height:100%;width:0%;;background:var(--accent);transition:width .3s ease}

    /* bottom nav */
    #bottomNav{position:absolute;left:0;right:0;bottom:0;height:64px;background:var(--panel);border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(3,1fr);padding:6px 8px;gap:6px}
    .navBtn{border:none;background:transparent;color:var(--muted);border-radius:14px;font-size:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px}
    .navBtn.active{background:rgba(27,182,106,.12);color:var(--text)}
    .navIco{font-size:18px;line-height:18px}

    /* legacy wrapper */
    #legacyWrap{position:fixed;inset:0;background:#fff;overflow:auto;display:none;z-index:99999;padding:14px}
    #legacyWrap .closeLegacy{position:fixed;right:14px;top:14px;z-index:100000}
    .leaflet-control-attribution{display:none}
    .leaflet-control-zoom{display:none}

    /* Legacy styles below */
    #legacyWrap{font-family:system-ui,Segoe UI,Roboto,Arial}

    .card{border:1px solid #e6e6e6;border-radius:14px;padding:12px;margin:10px 0}
    input,button,select{width:100%;padding:10px;border-radius:12px;border:1px solid #d9d9d9;font-size:16px}
    button{border:none;background:#111;color:#fff}
    .row{display:grid;grid-template-columns:1fr;gap:8px}
    .muted{color:#666;font-size:13px}
    .list{margin-top:8px}
    .item{padding:8px;border:1px dashed #ddd;border-radius:12px;margin:6px 0}
    .btnSmall{padding:8px 10px;border-radius:10px;border:0;background:#b00020;color:#fff;font-size:14px;width:auto}
    .actions{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Cancel reason modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:14px;border:1px solid #e6e6e6}
    .modal h3{margin:6px 0 10px 0;font-size:18px}
    .modal .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .modal textarea{width:100%;min-height:72px;padding:10px;border-radius:12px;border:1px solid #d9d9d9;font-size:15px;resize:vertical}
    .btnGhost{background:#eee;color:#111}
  </style>
</head>
<body>
  <div id="mapWrap">
    <div id="map"></div>
    <button class="mapBtn" id="btnMenu" type="button">‚ò∞</button>
    <button class="mapBtn" id="btnCenter" type="button">üéØ</button>
  </div>

  <div id="sheet">
    <div id="sheetHandle"></div>
    <div id="sheetInner">
      <div class="muted" id="who2" style="margin:2px 2px 6px 2px"></div>

      <div id="stateIdle">
        <div class="title">Haraya?</div>
        <div class="card">
          <div class="row">
            <input id="dest2" placeholder="T…ôyinat yeri" autocomplete="off" />
            <div class="list" id="dest2List"></div>
            <button id="btnRequest2" type="button">Sifari≈ü et</button>
            <div class="muted" id="req2Status">‚Äî</div>
          </div>
        </div>
      </div>

      <div id="stateSearching" style="display:none">
        <div class="title">S√ºr√ºc√º axtarƒ±lƒ±r</div>
        <div class="card">
          <div class="muted" id="searchSub">Yaxƒ±n s√ºr√ºc√ºl…ôr…ô t…ôklif g√∂nd…ôrilir‚Ä¶</div>
          <div class="progress" style="margin:10px 0"><div id="offerBar"></div></div>
          <div class="two">
            <button id="btnCancelRide2" class="danger" type="button">Gedi≈üi l…ôƒüv et</button>
            <button id="btnLegacy" class="secondary" type="button">Legacy panel</button>
          </div>
        </div>
      </div>

      <div id="stateAssigned" style="display:none">
        <div class="title">S√ºr√ºc√º yoldadƒ±r</div>
        <div class="card" id="driverCard2">
          <b id="drvName2">‚Äî</b>
          <div class="muted" id="drvCar2">‚Äî</div>
          <div class="muted" id="drvEta2">‚Äî</div>
          <div class="two" style="margin-top:10px">
            <button id="btnCall2" class="secondary" type="button">Z…ông</button>
            <button id="btnCancelRide3" class="danger" type="button">L…ôƒüv et</button>
          </div>
          <div class="muted" style="margin-top:8px">Qeyd: Z…ông d√ºym…ôsi demo rejimd…ôdir (telefon n√∂mr…ôsi DB-d…ô saxlananda aktivl…ô≈ü…ôc…ôk).</div>
        </div>
      </div>

      <div class="card" id="hintCard">
        <div class="muted">Pick-up: avtomatik olaraq cari yeriniz g√∂t√ºr√ºl√ºr (GPS). ∆èg…ôr GPS icaz…ôsi yoxdursa, telefonun Location icaz…ôsini aktiv edin.</div>
      </div>
    </div>
  </div>

  <div id="bottomNav">
    <button class="navBtn active" id="navHome" type="button"><div class="navIco">üè†</div>∆èsas ekran</button>
    <button class="navBtn" id="navRides" type="button"><div class="navIco">üßæ</div>Gedi≈ü</button>
    <button class="navBtn" id="navAccount" type="button"><div class="navIco">üë§</div>Hesab</button>
  </div>

  <div id="legacyWrap">
    <button class="closeLegacy" id="btnCloseLegacy" type="button">‚úñ</button>
    <h2>PayTaksi üöï</h2>
  <div class="muted" id="who"></div>

  <div class="card">
    <div class="row">
      <button id="btnLoc">üìç M√∂vcud yerimi avtomatik tap</button>
      <div class="muted" id="locTxt">Yer: ‚Äî</div>

      <input id="pickupTxt" placeholder="M√∂vcud yeriniz (GPS il…ô avtomatik yazƒ±lacaq)" />
      <div class="list" id="pickupSuggestions"></div>

      <input id="dest" placeholder="Ged…ôc…ôyiniz yeri yazƒ±n (m…ôs: Nizami metro)" />
      <div class="list" id="suggestions"></div>

      <button id="btnCreate">üöï Sifari≈ü ver</button>
      <div class="muted" id="status">‚Äî</div>
    </div>
  </div>

  <div class="card">
    <b>Son sifari≈ül…ôr</b>
    <div class="list" id="rides"></div>
  </div>

  <!-- Cancel reason modal -->
  <div class="modalBack" id="cancelBack">
    <div class="modal">
      <h3>‚ùå Sifari≈üi l…ôƒüv et</h3>
      <div class="muted" id="cancelInfo">‚Äî</div>
      <div class="row" style="margin-top:10px">
        <select id="cancelReason">
          <option value="">S…ôb…ôb se√ßin</option>
          <option>S√ºr√ºc√º gecikir</option>
          <option>Fikrim d…ôyi≈üdi</option>
          <option>Yanlƒ±≈ü √ºnvan se√ßdim</option>
          <option>Qiym…ôt uyƒüun deyil</option>
          <option>Dig…ôr‚Ä¶</option>
        </select>
        <textarea id="cancelNote" placeholder="Dig…ôr s…ôb…ôb (ist…ôy…ô baƒülƒ±)" style="display:none"></textarea>
        <div class="two">
          <button id="cancelNo" class="btnGhost">Geri</button>
          <button id="cancelYes" class="btnSmall" style="width:100%">L…ôƒüv et</button>
        </div>
        <div class="muted">L…ôƒüv etdikd…ô (…ôg…ôr s√ºr√ºc√º t…ôyin olunubsa) s√ºr√ºc√ºy…ô bildiri≈ü ged…ôc…ôk.</div>
      </div>
    </div>
  </div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const who = document.getElementById('who');
const statusEl = document.getElementById('status');
const locTxt = document.getElementById('locTxt');
const ridesEl = document.getElementById('rides');
const suggEl = document.getElementById('suggestions');
const pickupInput = document.getElementById('pickupTxt');
const pickupSuggEl = document.getElementById('pickupSuggestions');

const u = tgUser();
who.textContent = u ? `ƒ∞stifad…ô√ßi: ${u.first_name || ''} (@${u.username||'-'})` : 'Local dev mode';

let lastDistanceKm = 0;

function haversineKm(a, b) {
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLon = (b.lon - a.lon) * Math.PI / 180;
  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;
  const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(x));
}
function calcFare(distanceKm) {
  const base = 3.50;
  if (!distanceKm || distanceKm <= 0) return base;
  if (distanceKm <= 3) return base;
  return base + (distanceKm - 3) * 0.40;
}
function updateFareUI() {
  const el = document.getElementById('fareInfo');
  if (!el) return;
  if (!pickup || !drop) { el.textContent = ''; lastDistanceKm = 0; return; }
  const km = haversineKm({lat:pickup.lat, lon:pickup.lon}, {lat:drop.lat, lon:drop.lon});
  lastDistanceKm = km;
  const fare = calcFare(km);
  el.textContent = `M…ôsaf…ô: ${km.toFixed(2)} km ‚Ä¢ T…ôxmini m…ôbl…ôƒü: ${fare.toFixed(2)} AZN`;
}

let pickup = null;
let drop = null;

document.getElementById('btnLoc').onclick = () => {
  setStatus(statusEl,'GPS sorƒüusu‚Ä¶');
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    pickup = { lat: pos.coords.latitude, lon: pos.coords.longitude, text: 'M…ônim yerim' };
    locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)} (tapƒ±lƒ±r‚Ä¶)`;

    // M√∂vcud yerin adƒ±nƒ± tap (reverse geocode)
    try{
      const url = new URL('/api/reverse', location.origin);
      url.searchParams.set('lat', pickup.lat);
      url.searchParams.set('lon', pickup.lon);
      const r = await fetch(url);
      const j = await r.json();
      if (j.ok && (j.name || j.display_name)){
        pickup.text = j.name || j.display_name;
        locTxt.textContent = `Yer: ${pickup.text}`;
        pickupInput.value = pickup.text;
      } else {
        locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)}`;
        pickupInput.value = '';
      }
    }catch(e){
      locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)}`;
      pickupInput.value = '';
    }

    setStatus(statusEl,'Yer tapƒ±ldƒ± ‚úÖ');
  }, (err)=>{
    setStatus(statusEl,'GPS icaz…ôsi verilm…ôdi ‚ùå', false);
  }, { enableHighAccuracy:true, timeout:10000 });
};

// --- Autocomplete helper
async function loadSuggestions(q, listEl, onPick){
  if (!q || q.length < 3){ listEl.innerHTML=''; return; }
  try{
    const url = new URL('/api/places', location.origin);
    url.searchParams.set('q', q);
    if (pickup){ url.searchParams.set('lat', pickup.lat); url.searchParams.set('lon', pickup.lon); }
    const r = await fetch(url);
    const data = await r.json();
    listEl.innerHTML = '';
    (data.items||[]).forEach((it)=>{
      const div = document.createElement('div');
      div.className='item';
      div.textContent = it.title;
      div.onclick = ()=> onPick(it);
      listEl.appendChild(div);
    });
  }catch(e){ listEl.innerHTML=''; }
}

let tmrPick = null;
pickupInput.addEventListener('input', (e)=>{
  clearTimeout(tmrPick);
  const q = e.target.value.trim();
  tmrPick = setTimeout(()=>{
    loadSuggestions(q, pickupSuggEl, (it)=>{
      // Allow user to override pickup by selecting a nearby place
      pickup = { lat: it.lat, lon: it.lon, text: it.title };
      pickupInput.value = it.title;
      locTxt.textContent = `Yer: ${it.title}`;
      pickupSuggEl.innerHTML='';
    });
  }, 250);
});


let tmr = null;
document.getElementById('dest').addEventListener('input', (e)=>{
  clearTimeout(tmr);
  const q = e.target.value.trim();
  if (q.length < 3){ suggEl.innerHTML=''; drop=null; return; }
  tmr = setTimeout(async ()=>{
    loadSuggestions(q, suggEl, (it)=>{
      drop = { lat: it.lat, lon: it.lon, text: it.title };
      document.getElementById('dest').value = it.title;
      suggEl.innerHTML='';
    });
  }, 250);
});

document.getElementById('btnCreate').onclick = async ()=>{
  if (!pickup) return setStatus(statusEl,'∆èvv…ôlc…ô yerinizi tapƒ±n (GPS).', false);
  if (!drop) return setStatus(statusEl,'Ged…ôc…ôyiniz yeri se√ßin.', false);
  try{
    setStatus(statusEl,'Sifari≈ü yaradƒ±lƒ±r‚Ä¶');
    const data = await api('/api/passenger/create_ride',{method:'POST',body:{
      pickup_lat: pickup.lat, pickup_lon: pickup.lon, pickup_text: pickup.text,
      drop_lat: drop.lat, drop_lon: drop.lon, drop_text: drop.text,
      distance_km: lastDistanceKm
    }});
    setStatus(statusEl,`Sifari≈ü #${data.ride.id} yaradƒ±ldƒ±. T…ôxmini qiym…ôt: ${data.ride.fare} AZN (komissiya: ${data.ride.commission} AZN)`);
    await loadRides();
  }catch(e){
    setStatus(statusEl,'X…ôta: '+(e.data?.reason||e.data?.error||e.message), false);
  }
};

async function loadRides(){
  try{
    const data = await api('/api/passenger/my_rides');
    ridesEl.innerHTML='';
    (data.rides||[]).forEach((r)=>{
      const div = document.createElement('div');
      div.className='item';
      const drv = r.driver_id ? `S√ºr√ºc√º: ${r.driver_first_name || ''} (@${r.driver_username||'-'})` : 'S√ºr√ºc√º: ‚Äî';
      const canCancel = (r.status === 'searching' || r.status === 'assigned');
      const canViewChat = (r.driver_id && ['assigned','started','completed','cancelled'].includes(String(r.status)));
      const canSendChat = (r.driver_id && (r.status === 'assigned' || r.status === 'started'));
      const canCall = (r.driver_id && (r.status === 'assigned' || r.status === 'started'));
      div.innerHTML = `<b>#${r.id}</b> ‚Ä¢ ${r.status}<br>
        ${r.pickup_text||''} ‚Üí ${r.drop_text||''}<br>
        M…ôsaf…ô: ${Number(r.distance_km).toFixed(2)} km ‚Ä¢ Qiym…ôt: ${r.fare} AZN<br>
        <span class="muted">${drv}</span>
        ${canViewChat ? `
          <div class="actions" style="margin-top:8px">
            <button class="btnSmall" data-chat="${r.id}">${canSendChat ? 'üí¨ Yazƒ±≈üma' : 'üìú Yazƒ±≈üma (arxiv)'}</button>
            ${canCall ? `<button class="btnSmall" data-call="${r.id}">üìû S√ºr√ºc√ºy…ô z…ông</button>` : ''}
          </div>
          <div class="card" data-chatbox="${r.id}" style="display:none;margin-top:8px;border-radius:12px;padding:10px">
            <div class="muted" style="margin-bottom:6px">${canSendChat ? 'Yazƒ±≈üma yalnƒ±z s√ºr√ºc√º q…ôbul ed…ônd…ôn sonra aktiv olur.' : 'Bu yazƒ±≈üma arxivdir (yalnƒ±z oxu).'}</div>
            <div data-msglist style="max-height:220px;overflow:auto;border:1px dashed #ddd;border-radius:12px;padding:8px"></div>
            ${canSendChat ? `
              <div class="row" style="margin-top:8px">
                <input data-msgtext placeholder="Mesaj yaz‚Ä¶" />
                <button class="btnSmall" data-send>G√∂nd…ôr</button>
              </div>
            ` : ''}
          </div>
        ` : ''}
        ${canCancel ? `<div class="actions"><button class="btnSmall" data-cancel="${r.id}">‚ùå L…ôƒüv et</button><span class="muted">(Sifari≈üin l…ôƒüv edilm…ôsi s√ºr√ºc√ºy…ô bildiril…ôc…ôk)</span></div>` : ''}`;
      ridesEl.appendChild(div);

      if (canCancel){
        const btn = div.querySelector('[data-cancel]');
        btn.onclick = async ()=>{
          const reason = await openCancelModal(r);
          if (reason === null) return;
          try{
            btn.disabled = true;
            await api('/api/passenger/cancel_ride',{method:'POST',body:{ride_id: Number(r.id), reason}});
            setStatus(statusEl,`Sifari≈ü #${r.id} l…ôƒüv edildi ‚úÖ`);
            await loadRides();
          }catch(e){
            setStatus(statusEl,'L…ôƒüv edil…ô bilm…ôdi: '+(e.data?.error||e.message), false);
          }finally{ btn.disabled = false; }
        };
      }

      if (canViewChat){
        // Call (Telegram) - only while active
        const bCall = div.querySelector('[data-call]');
        if (bCall) {
          bCall.onclick = ()=>{
            openTelegramUser({ tg_id: r.driver_tg_id, username: r.driver_username });
          };
        }

        // Chat toggle
        const bChat = div.querySelector('[data-chat]');
        const box = div.querySelector('[data-chatbox]');
        const list = box.querySelector('[data-msglist]');
        const input = box.querySelector('[data-msgtext]');
        const bSend = box.querySelector('[data-send]');

        let chatTimer = null;
        let lastRendered = 0;

        async function refreshChat(){
          try{
            const data = await api('/api/passenger/ride_messages?ride_id='+encodeURIComponent(r.id));
            const msgs = data.messages || [];
            if (!msgs.length){
              list.innerHTML = '<div class="muted">H…ôl…ô mesaj yoxdur.</div>';
              return;
            }
            // Render only if changed
            const lastId = msgs[msgs.length-1].id || 0;
            if (lastId === lastRendered) return;
            lastRendered = lastId;
            list.innerHTML = '';
            msgs.forEach((m)=>{
              const mine = m.sender_role === 'passenger';
              const divm = document.createElement('div');
              divm.style.margin = '6px 0';
              divm.style.textAlign = mine ? 'right' : 'left';
              divm.innerHTML = `<span style="display:inline-block;max-width:88%;padding:8px 10px;border-radius:12px;border:1px solid #e6e6e6;${mine?'background:#111;color:#fff;border-color:#111':''}">${escapeHtml(m.message)}</span>`;
              list.appendChild(divm);
            });
            list.scrollTop = list.scrollHeight;
          }catch(e){}
        }

        bChat.onclick = async ()=>{
          const open = box.style.display !== 'none';
          if (open){
            box.style.display = 'none';
            bChat.textContent = canSendChat ? 'üí¨ Yazƒ±≈üma' : 'üìú Yazƒ±≈üma (arxiv)';
            if (chatTimer) { clearInterval(chatTimer); chatTimer = null; }
            return;
          }
          box.style.display = '';
          bChat.textContent = '‚úñ Baƒüla';
          await refreshChat();
          chatTimer = setInterval(refreshChat, 3000);
        };

        if (bSend){
          bSend.onclick = async ()=>{
            const text = String(input.value||'').trim();
            if (!text) return;
            bSend.disabled = true;
            try{
              await api('/api/passenger/send_message',{method:'POST',body:{ride_id:Number(r.id), message:text}});
              input.value='';
              await refreshChat();
            }catch(e){
              alert('X…ôta: '+(e.data?.error||e.data?.reason||e.message));
            }finally{ bSend.disabled = false; }
          };
        }
      }
    });
    if (!data.rides?.length) ridesEl.innerHTML = '<div class="muted">H…ôl…ô sifari≈ü yoxdur.</div>';
  }catch(e){}
}

function escapeHtml(s){
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function openTelegramUser(user){
  const tg_id = user?.tg_id;
  const username = user?.username;
  const url = username ? `https://t.me/${encodeURIComponent(username)}` : `tg://user?id=${encodeURIComponent(String(tg_id||''))}`;
  try{
    if (Telegram?.WebApp?.openTelegramLink) Telegram.WebApp.openTelegramLink(url);
    else window.open(url,'_blank');
  }catch{ window.open(url,'_blank'); }
}
loadRides();
setInterval(loadRides, 4000);



// =========================
// Premium Passenger UI (Bolt-like) - additive layer
// =========================
function initPremiumPassengerUI(){
  // =========================
  // Premium Passenger UI (Bolt-like) - additive layer
  // Keeps legacy panel intact (in #legacyWrap) and reuses existing API helpers.
  // =========================
  const who2 = document.getElementById('who2');
  const dest2 = document.getElementById('dest2');
  const dest2List = document.getElementById('dest2List');
  const btnRequest2 = document.getElementById('btnRequest2');
  const req2Status = document.getElementById('req2Status');
  const stateIdle = document.getElementById('stateIdle');
  const stateSearching = document.getElementById('stateSearching');
  const stateAssigned = document.getElementById('stateAssigned');
  const offerBar = document.getElementById('offerBar');
  const searchSub = document.getElementById('searchSub');
  const btnCancelRide2 = document.getElementById('btnCancelRide2');
  const btnCancelRide3 = document.getElementById('btnCancelRide3');
  const btnLegacy = document.getElementById('btnLegacy');
  const legacyWrap = document.getElementById('legacyWrap');
  const btnCloseLegacy = document.getElementById('btnCloseLegacy');
  const btnMenu = document.getElementById('btnMenu');
  const btnCenter = document.getElementById('btnCenter');
  
  const drvName2 = document.getElementById('drvName2');
  const drvCar2 = document.getElementById('drvCar2');
  const drvEta2 = document.getElementById('drvEta2');
  const btnCall2 = document.getElementById('btnCall2');
  
  if (who2) who2.textContent = u ? `üë§ ${u.first_name || ''} (@${u.username||'-'})` : 'Local dev mode';
  
  // --- Leaflet map
  let __pMap = null;
  let __pPickMarker = null;
  let __pDropMarker = null;
  let __pDrvMarker = null;
  let __pLine = null;
  
  function initPassengerMap(){
    try{
      if (__pMap) return;
      __pMap = L.map('map', { zoomControl:false, attributionControl:false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(__pMap);
      __pMap.setView([40.4093, 49.8671], 12); // Baku default
    }catch(_){}
  }
  initPassengerMap();
  
  function setPickMarker(lat, lon){
    if (!__pMap || !isFinite(lat) || !isFinite(lon)) return;
    if (!__pPickMarker) __pPickMarker = L.marker([lat, lon]).addTo(__pMap);
    __pPickMarker.setLatLng([lat, lon]);
  }
  function setDropMarker(lat, lon){
    if (!__pMap || !isFinite(lat) || !isFinite(lon)) return;
    if (!__pDropMarker) __pDropMarker = L.marker([lat, lon]).addTo(__pMap);
    __pDropMarker.setLatLng([lat, lon]);
  }
  function setDrvMarker(lat, lon){
    if (!__pMap || !isFinite(lat) || !isFinite(lon)) return;
    if (!__pDrvMarker) __pDrvMarker = L.marker([lat, lon]).addTo(__pMap);
    __pDrvMarker.setLatLng([lat, lon]);
  }
  function drawLine(points){
    try{
      if (!__pMap) return;
      if (__pLine){ __pMap.removeLayer(__pLine); __pLine = null; }
      if (!points || points.length < 2) return;
      __pLine = L.polyline(points, { weight: 5, opacity: 0.9 }).addTo(__pMap);
      __pMap.fitBounds(__pLine.getBounds(), { padding:[40,40] });
    }catch(_){}
  }
  function centerOnPickup(){
    if (!__pMap || !pickup) return;
    __pMap.setView([pickup.lat, pickup.lon], 16);
  }
  
  if (btnCenter) btnCenter.onclick = centerOnPickup;
  if (btnMenu) btnMenu.onclick = ()=>{ legacyWrap.style.display='block'; };
  if (btnLegacy) btnLegacy.onclick = ()=>{ legacyWrap.style.display='block'; };
  if (btnCloseLegacy) btnCloseLegacy.onclick = ()=>{ legacyWrap.style.display='none'; };
  
  // --- New destination autocomplete (reuses loadSuggestions)
  let tmr2 = null;
  if (dest2){
    dest2.addEventListener('input', (e)=>{
      clearTimeout(tmr2);
      const q = e.target.value.trim();
      if (q.length < 3){ dest2List.innerHTML=''; drop=null; updateFareUI(); return; }
      tmr2 = setTimeout(()=>{
        loadSuggestions(q, dest2List, (it)=>{
          drop = { lat: it.lat, lon: it.lon, text: it.title };
          dest2.value = it.title;
          dest2List.innerHTML='';
          try{ setDropMarker(drop.lat, drop.lon); }catch(_){}
          updateFareUI();
          if (pickup) drawLine([[pickup.lat,pickup.lon],[drop.lat,drop.lon]]);
        });
      }, 250);
    });
  }
  
  function uiShowState(name){
    if (!stateIdle) return;
    stateIdle.style.display = (name === 'idle') ? '' : 'none';
    stateSearching.style.display = (name === 'searching') ? '' : 'none';
    stateAssigned.style.display = (name === 'assigned') ? '' : 'none';
  }
  
  // --- Ensure pickup via GPS immediately for premium UI
  async function ensurePickup(){
    if (pickup) return pickup;
    return new Promise((resolve)=>{
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        pickup = { lat: pos.coords.latitude, lon: pos.coords.longitude, text: 'M…ônim yerim' };
        try{ setPickMarker(pickup.lat, pickup.lon); __pMap && __pMap.setView([pickup.lat,pickup.lon], 16); }catch(_){}
        // Reverse geocode (best-effort)
        try{
          const url = new URL('/api/reverse', location.origin);
          url.searchParams.set('lat', pickup.lat);
          url.searchParams.set('lon', pickup.lon);
          const r = await fetch(url);
          const j = await r.json();
          if (j.ok && (j.name || j.display_name)) pickup.text = j.name || j.display_name;
        }catch(_){}
        resolve(pickup);
      }, ()=>{
        resolve(null);
      }, { enableHighAccuracy:true, timeout:12000 });
    });
  }
  
  async function createRideFromPremium(){
    const pck = await ensurePickup();
    if (!pck){ req2Status.textContent = 'GPS icaz…ôsi yoxdur. Telefonun Location icaz…ôsini aktiv edin.'; return; }
    if (!drop){ req2Status.textContent = 'T…ôyinat se√ßin.'; return; }
    try{
      req2Status.textContent = 'Sifari≈ü yaradƒ±lƒ±r‚Ä¶';
      const data = await api('/api/passenger/create_ride',{method:'POST',body:{
        pickup_lat: pck.lat, pickup_lon: pck.lon, pickup_text: pck.text,
        drop_lat: drop.lat, drop_lon: drop.lon, drop_text: drop.text,
        distance_km: lastDistanceKm
      }});
      req2Status.textContent = `Sifari≈ü #${data.ride.id} yaradƒ±ldƒ±.`;
      uiShowState('searching');
      // Legacy refresh too
      try{ await loadRides(); }catch(_){}
    }catch(e){
      req2Status.textContent = 'X…ôta: '+(e.data?.reason||e.data?.error||e.message);
    }
  }
  
  if (btnRequest2) btnRequest2.onclick = createRideFromPremium;
  
  // --- Active ride polling (shows Bolt-like states)
  let __activeRideId = null;
  
  function computeEtaMin(driverLat, driverLon){
    try{
      if (!pickup || !isFinite(driverLat) || !isFinite(driverLon)) return null;
      const km = haversineKm({lat:driverLat, lon:driverLon}, {lat:pickup.lat, lon:pickup.lon});
      const speedKmh = 25; // rough city speed
      const min = Math.max(1, Math.round((km / speedKmh) * 60));
      return min;
    }catch(_){ return null; }
  }
  
  function renderActiveRide(r){
    if (!r){
      __activeRideId = null;
      offerBar && (offerBar.style.width = '0%');
      uiShowState('idle');
      if (__pDrvMarker){ try{ __pMap.removeLayer(__pDrvMarker); }catch(_){ } __pDrvMarker=null; }
      return;
    }
  
    __activeRideId = Number(r.id);
    // markers
    if (pickup){ setPickMarker(pickup.lat, pickup.lon); }
    if (r.pickup_lat && r.pickup_lon){ setPickMarker(Number(r.pickup_lat), Number(r.pickup_lon)); }
    if (r.drop_lat && r.drop_lon){ setDropMarker(Number(r.drop_lat), Number(r.drop_lon)); }
    const linePts = [];
    if (r.pickup_lat && r.pickup_lon) linePts.push([Number(r.pickup_lat), Number(r.pickup_lon)]);
    if (r.drop_lat && r.drop_lon) linePts.push([Number(r.drop_lat), Number(r.drop_lon)]);
    if (linePts.length===2) drawLine(linePts);
  
    // searching with offer
    if (String(r.status) === 'searching'){
      uiShowState('searching');
      const hasOffer = r.offered_driver_id != null;
      if (hasOffer){
        const exp = r.offer_expires_at ? new Date(r.offer_expires_at).getTime() : 0;
        const now = Date.now();
        const total = Math.max(1, Number(20) * 1000);
        let pct = 0;
        if (exp) pct = Math.max(0, Math.min(1, (exp - now) / total));
        offerBar && (offerBar.style.width = Math.round(pct*100) + '%');
        searchSub && (searchSub.textContent = 'S√ºr√ºc√ºn√ºn sifari≈üi t…ôsdiql…ôm…ôsi g√∂zl…ônilir');
      } else {
        offerBar && (offerBar.style.width = '0%');
        searchSub && (searchSub.textContent = 'Yaxƒ±n s√ºr√ºc√ºl…ôr…ô t…ôklif g√∂nd…ôrilir‚Ä¶');
      }
      return;
    }
  
    if (String(r.status) === 'assigned' || String(r.status) === 'started'){
      uiShowState('assigned');
      const name = (r.driver_first_name || '').trim() || 'S√ºr√ºc√º';
      const plate = (r.driver_plate || '').trim();
      const car = [r.driver_car_make, r.driver_car_model].filter(Boolean).join(' ');
      const color = (r.driver_car_color || '').trim();
      drvName2 && (drvName2.textContent = name + (plate ? ` ‚Ä¢ ${plate}` : ''));
      drvCar2 && (drvCar2.textContent = [car, color, r.driver_car_year].filter(Boolean).join(' ‚Ä¢ ') || '‚Äî');
  
      // driver last loc -> eta
      const dlat = Number(r.driver_last_lat), dlon = Number(r.driver_last_lon);
      if (isFinite(dlat) && isFinite(dlon)){
        setDrvMarker(dlat, dlon);
        const eta = computeEtaMin(dlat, dlon);
        drvEta2 && (drvEta2.textContent = eta ? `${eta} d…ôqiq…ôy…ô √ßatƒ±r` : '‚Äî');
      } else {
        drvEta2 && (drvEta2.textContent = '‚Äî');
      }
      offerBar && (offerBar.style.width = '100%');
      return;
    }
  
    // completed/cancelled -> back to idle
    uiShowState('idle');
  }
  
  async function pollActiveRide(){
    try{
      const data = await api('/api/passenger/my_rides');
      const rides = data.rides || [];
      const active = rides.find(r => !['completed','cancelled'].includes(String(r.status)));
      renderActiveRide(active || null);
    }catch(_){}
  }
  
  if (btnCancelRide2) btnCancelRide2.onclick = async ()=>{
    if (!__activeRideId) return;
    try{
      // Prefer modal (legacy) for reason
      let reason = null;
      try{
        const data = await api('/api/passenger/my_rides');
        const rides = data.rides || [];
        const ride = rides.find(x=>Number(x.id)===Number(__activeRideId));
        if (ride) reason = await openCancelModal(ride);
      }catch(_){}
      await api('/api/passenger/cancel_ride', { method:'POST', body:{ ride_id: __activeRideId, reason }});
      await pollActiveRide();
      try{ await loadRides(); }catch(_){}
    }catch(e){
      alert('L…ôƒüv x…ôtasƒ±: '+(e.data?.error||e.data?.reason||e.message));
    }
  };
  if (btnCancelRide3) btnCancelRide3.onclick = btnCancelRide2 ? btnCancelRide2.onclick : null;
  if (btnCall2) btnCall2.onclick = ()=> alert('Demo: telefon n√∂mr…ôsi DB-d…ô saxlananda burada z…ông a√ßƒ±lacaq.');
  
  setInterval(pollActiveRide, 4000);
  setTimeout(async ()=>{
    try{ await ensurePickup(); }catch(_){}
    try{ await pollActiveRide(); }catch(_){}
  }, 600);
  
  
  </script>
    <script src="../assets/common.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
}

try{ initPremiumPassengerUI(); }catch(e){ console.warn('premium ui init failed', e); }

// ---- Cancel modal helpers
const cancelBack = document.getElementById('cancelBack');
const cancelInfo = document.getElementById('cancelInfo');
const cancelReason = document.getElementById('cancelReason');
const cancelNote = document.getElementById('cancelNote');
const cancelNo = document.getElementById('cancelNo');
const cancelYes = document.getElementById('cancelYes');

cancelReason.addEventListener('change', ()=>{
  const v = String(cancelReason.value||'');
  cancelNote.style.display = (v && v.startsWith('Dig…ôr')) ? '' : 'none';
});

function openCancelModal(ride){
  return new Promise((resolve)=>{
    cancelInfo.innerHTML = `<b>#${ride.id}</b> ‚Ä¢ ${ride.pickup_text||''} ‚Üí ${ride.drop_text||''}`;
    cancelReason.value = '';
    cancelNote.value = '';
    cancelNote.style.display = 'none';
    cancelBack.style.display = 'flex';

    const close = (val)=>{
      cancelBack.style.display = 'none';
      cancelNo.onclick = null;
      cancelYes.onclick = null;
      resolve(val);
    };

    cancelNo.onclick = ()=> close(null);
    cancelBack.onclick = (e)=>{ if (e.target === cancelBack) close(null); };
    cancelYes.onclick = ()=>{
      const sel = String(cancelReason.value||'').trim();
      if (!sel) { alert('S…ôb…ôb se√ßin.'); return; }
      let text = sel;
      if (sel.startsWith('Dig…ôr')) {
        const note = String(cancelNote.value||'').trim();
        if (note) text = note;
      }
      close(text.slice(0,200));
    };
  });
}

</script>

<script>
// --- Premium passenger UI wiring (Stage1 Hotfix2)
(function(){
  const who2 = document.getElementById('who2');
  const req2Status = document.getElementById('req2Status');
  const dest2 = document.getElementById('dest2');
  const dest2List = document.getElementById('dest2List');
  const btnRequest2 = document.getElementById('btnRequest2');
  const btnCenter = document.getElementById('btnCenter');
  const btnLegacy = document.getElementById('btnLegacy');
  const legacyWrap = document.getElementById('legacyWrap');
  const btnCloseLegacy = document.getElementById('btnCloseLegacy');

  const stateIdle = document.getElementById('stateIdle');
  const stateSearching = document.getElementById('stateSearching');
  const offerBar = document.getElementById('offerBar');

  const u = (typeof tgUser === 'function') ? tgUser() : null;
  if (who2) who2.textContent = u ? `ƒ∞stifad…ô√ßi: ${u.first_name||''} (@${u.username||'-'})` : 'Local dev mode';

  function setReq(msg, ok=true){
    if (!req2Status) return;
    req2Status.textContent = msg;
    req2Status.style.color = ok ? '' : 'crimson';
  }

  // Leaflet map
  let map = null;
  let pickupMarker = null;
  let pickupCircle = null;
  let pickup = null;
  let drop = null;
  let dropMarker = null;

  function ensureMap(){
    if (map) return map;
    try{
      map = L.map('map', { zoomControl:false, attributionControl:false });
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
      map.setView([40.4093, 49.8671], 13);
    }catch(e){
      setReq('X…ôrit…ô a√ßƒ±la bilm…ôdi (Leaflet).', false);
    }
    return map;
  }

  function setPickup(lat, lon, text){
    pickup = { lat, lon, text: text||'M…ônim yerim' };
    const m = ensureMap();
    if (!m) return;
    const ll = [lat, lon];
    if (!pickupMarker){
      pickupMarker = L.circleMarker(ll, { radius:8, weight:2, fillOpacity:1 }).addTo(m);
    } else pickupMarker.setLatLng(ll);

    if (!pickupCircle){
      pickupCircle = L.circle(ll, { radius: 60, weight:1, fillOpacity:0.12 }).addTo(m);
    } else pickupCircle.setLatLng(ll);

    m.setView(ll, Math.max(m.getZoom(), 15));
  }

  function setDrop(lat, lon, text){
    drop = { lat, lon, text: text||'T…ôyinat' };
    const m = ensureMap();
    if (!m) return;
    const ll = [lat, lon];
    if (!dropMarker){
      dropMarker = L.marker(ll).addTo(m);
    } else dropMarker.setLatLng(ll);
  }

  async function reverseName(lat, lon){
    try{
      const url = new URL('/api/reverse', location.origin);
      url.searchParams.set('lat', lat);
      url.searchParams.set('lon', lon);
      const r = await fetch(url);
      const j = await r.json();
      if (j.ok && (j.name || j.display_name)) return (j.name || j.display_name);
    }catch(e){}
    return null;
  }

  async function ensurePickup(){
    if (pickup) return pickup;
    setReq('GPS oxunur‚Ä¶');
    return new Promise((resolve)=>{
      if (!navigator.geolocation) { setReq('GPS d…ôst…ôkl…ônmir.', false); return resolve(null); }
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        let name = await reverseName(lat, lon);
        setPickup(lat, lon, name||'M…ônim yerim');
        setReq(name ? `Pick-up: ${name}` : 'Yer tapƒ±ldƒ± ‚úÖ');
        resolve(pickup);
      }, (err)=>{
        setReq('GPS icaz…ôsi verilm…ôdi. Telefon Location icaz…ôsini aktiv edin.', false);
        resolve(null);
      }, { enableHighAccuracy:true, timeout:12000 });
    });
  }

  // Autocomplete via backend /api/places
  let tmr2 = null;
  async function loadSuggestions2(q){
    if (!q || q.length < 3){ dest2List.innerHTML = ''; return; }
    try{
      const url = new URL('/api/places', location.origin);
      url.searchParams.set('q', q);
      if (pickup){ url.searchParams.set('lat', pickup.lat); url.searchParams.set('lon', pickup.lon); }
      const r = await fetch(url);
      const data = await r.json();
      dest2List.innerHTML = '';
      (data.items||[]).forEach((it)=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = it.title;
        div.onclick = ()=>{
          dest2.value = it.title;
          dest2List.innerHTML = '';
          setDrop(it.lat, it.lon, it.title);
          setReq('T…ôyinat se√ßildi ‚úÖ');
        };
        dest2List.appendChild(div);
      });
      if (!(data.items||[]).length) setReq('Alternativ tapƒ±lmadƒ± (3+ h…ôrf yazƒ±n).', true);
    }catch(e){
      dest2List.innerHTML = '';
      setReq('Axtarƒ±≈ü xidm…ôti i≈ül…ômir (/api/places).', false);
    }
  }

  if (dest2){
    dest2.addEventListener('input', (e)=>{
      drop = null;
      clearTimeout(tmr2);
      const q = String(e.target.value||'').trim();
      tmr2 = setTimeout(()=> loadSuggestions2(q), 250);
    });
  }

  if (btnCenter){
    btnCenter.onclick = async ()=>{
      const p = await ensurePickup();
      if (p && map) map.setView([p.lat,p.lon], 16);
    };
  }

  // Legacy panel open
  if (btnLegacy && legacyWrap && btnCloseLegacy){
    btnLegacy.onclick = ()=>{ legacyWrap.style.display = 'block'; };
    btnCloseLegacy.onclick = ()=>{ legacyWrap.style.display = 'none'; };
  }

  async function createRide(){
    const p = await ensurePickup();
    if (!p) return;
    if (!drop){ setReq('Ged…ôc…ôyiniz yeri siyahƒ±dan se√ßin.', false); return; }
    try{
      setReq('Sifari≈ü yaradƒ±lƒ±r‚Ä¶');
      const data = await api('/api/passenger/create_ride', { method:'POST', body:{
        pickup_lat:p.lat, pickup_lon:p.lon, pickup_text:p.text,
        drop_lat:drop.lat, drop_lon:drop.lon, drop_text:drop.text
      }});
      const ride = data.ride || data;
      setReq(`Sifari≈ü #${ride.id} yaradƒ±ldƒ±. S√ºr√ºc√º axtarƒ±lƒ±r‚Ä¶`);
      if (stateIdle) stateIdle.style.display = 'none';
      if (stateSearching) stateSearching.style.display = '';
      let pct = 0;
      const tick = setInterval(()=>{
        pct = Math.min(100, pct + 4);
        if (offerBar) offerBar.style.width = pct + '%';
        if (pct >= 100) clearInterval(tick);
      }, 500);
    }catch(e){
      setReq('X…ôta: ' + (e?.data?.reason || e?.data?.error || e.message), false);
    }
  }

  if (btnRequest2) btnRequest2.onclick = createRide;

  // Auto init
  setTimeout(()=>{ ensureMap(); ensurePickup(); }, 50);
})();
</script>

  </div>
</body>

</html>
