<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi - S…ôrni≈üin</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="../assets/common.js"></script>
  <style>
    :root{--bg:#fff;--text:#111;--muted:#666;--card:#ffffff;--border:#e6e6e6;--danger:#b00020;--primary:#111;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:14px;background:var(--bg);color:var(--text)}
    h2{margin:6px 0 2px 0}
    .muted{color:var(--muted);font-size:13px}
    .card{border:1px solid var(--border);border-radius:16px;padding:12px;margin:10px 0;background:var(--card)}
    input,button,select{width:100%;padding:12px;border-radius:14px;border:1px solid #d9d9d9;font-size:16px;box-sizing:border-box}
    button{border:none;background:var(--primary);color:#fff;font-weight:700}
    button:disabled{opacity:.5}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    .list{margin-top:6px}
    .item{padding:10px;border:1px dashed #ddd;border-radius:14px;margin:8px 0;cursor:pointer}
    .actions{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btnSmall{padding:10px 12px;border-radius:12px;border:0;background:var(--danger);color:#fff;font-size:14px;width:auto;font-weight:700}
    .btnGhost{background:#eee;color:#111}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    /* Cancel reason modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:14px;border:1px solid #e6e6e6}
    .modal h3{margin:6px 0 10px 0;font-size:18px}
    .modal textarea{width:100%;min-height:72px;padding:10px;border-radius:12px;border:1px solid #d9d9d9;font-size:15px;resize:vertical}

    /* Small driver card */
    .driverCard{border:1px solid var(--border);border-radius:16px;padding:12px;margin-top:10px}
    .driverTop{display:flex;gap:10px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:50%;background:#f2f2f2;display:flex;align-items:center;justify-content:center;font-weight:800}
    .driverName{font-weight:900}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f3f3;font-size:12px;margin-top:4px}
    .btnRow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .btnRow button{width:auto;flex:1;min-width:110px}
    .btnCall{background:#111}
    .btnMsg{background:#222}
    .btnCancel{background:var(--danger)}
  </style>
</head>
<body>
  <h2>PayTaksi üöï</h2>
  <div class="muted" id="who"></div>

  <div class="card">
    <div class="row">
      <button id="btnLoc">üìç M√∂vcud yerimi avtomatik tap</button>
      <div class="muted" id="locTxt">Yer: ‚Äî</div>

      <input id="pickupTxt" placeholder="M√∂vcud yeriniz (GPS il…ô avtomatik yazƒ±lacaq)" />
      <div class="list" id="pickupSuggestions"></div>

      <input id="dest" placeholder="Ged…ôc…ôyiniz yeri yazƒ±n (m…ôs: K√∂hn…ô Ciy…ôrxana)" />
      <div class="list" id="suggestions"></div>

      <button id="btnCreate">üöï Sifari≈ü ver</button>
      <div class="muted" id="status">‚Äî</div>

      <div id="activeWrap" style="display:none"></div>
    </div>
  </div>

  <div class="card">
    <b>Son sifari≈ül…ôr</b>
    <div class="list" id="rides"></div>
  </div>

  <!-- Cancel reason modal -->
  <div class="modalBack" id="cancelBack">
    <div class="modal">
      <h3>‚ùå Sifari≈üi l…ôƒüv et</h3>
      <div class="muted" id="cancelInfo">‚Äî</div>
      <div class="row" style="margin-top:10px">
        <select id="cancelReason">
          <option value="">S…ôb…ôb se√ßin</option>
          <option>S√ºr√ºc√º gecikir</option>
          <option>Fikrim d…ôyi≈üdi</option>
          <option>Yanlƒ±≈ü √ºnvan se√ßdim</option>
          <option>Qiym…ôt uyƒüun deyil</option>
          <option>Dig…ôr‚Ä¶</option>
        </select>
        <textarea id="cancelNote" placeholder="Dig…ôr s…ôb…ôb (ist…ôy…ô baƒülƒ±)" style="display:none"></textarea>
        <div class="two">
          <button id="cancelNo" class="btnGhost">Geri</button>
          <button id="cancelYes" class="btnSmall" style="width:100%">L…ôƒüv et</button>
        </div>
        <div class="muted">L…ôƒüv etdikd…ô (…ôg…ôr s√ºr√ºc√º t…ôyin olunubsa) s√ºr√ºc√ºy…ô bildiri≈ü ged…ô bil…ôr.</div>
      </div>
    </div>
  </div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const who = document.getElementById('who');
const statusEl = document.getElementById('status');
const locTxt = document.getElementById('locTxt');
const ridesEl = document.getElementById('rides');
const suggEl = document.getElementById('suggestions');
const pickupInput = document.getElementById('pickupTxt');
const pickupSuggEl = document.getElementById('pickupSuggestions');
const activeWrap = document.getElementById('activeWrap');

const u = tgUser();
who.textContent = u ? `ƒ∞stifad…ô√ßi: ${u.first_name || ''} (@${u.username||'-'})` : 'Local dev mode';

let pickup = null;
let drop = null;

function setStatus(el, txt, ok=true){
  el.textContent = txt;
  el.style.color = ok ? '#666' : '#b00020';
}

// Reverse helper
async function reverseName(lat, lon){
  try{
    const url = new URL('/api/reverse', location.origin);
    url.searchParams.set('lat', lat);
    url.searchParams.set('lon', lon);
    const r = await fetch(url);
    const j = await r.json();
    if (j && j.ok && (j.name || j.display_name)) return (j.name || j.display_name);
  }catch(e){}
  return null;
}

// Autocomplete helper
async function loadSuggestions(q, listEl, onPick){
  if (!q || q.length < 3){ listEl.innerHTML=''; return; }
  try{
    const url = new URL('/api/places', location.origin);
    url.searchParams.set('q', q);
    if (pickup){ url.searchParams.set('lat', pickup.lat); url.searchParams.set('lon', pickup.lon); }
    const r = await fetch(url);
    const data = await r.json();
    listEl.innerHTML = '';
    (data.items||[]).forEach((it)=>{
      const div = document.createElement('div');
      div.className='item';
      div.textContent = it.title;
      div.onclick = ()=> onPick(it);
      listEl.appendChild(div);
    });
  }catch(e){ listEl.innerHTML=''; }
}

// GPS button
const btnLoc = document.getElementById('btnLoc');
btnLoc.onclick = () => {
  setStatus(statusEl,'GPS sorƒüusu‚Ä¶');
  btnLoc.disabled = true;
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    pickup = { lat: pos.coords.latitude, lon: pos.coords.longitude, text: 'M…ônim yerim' };
    locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)} (tapƒ±lƒ±r‚Ä¶)`;
    const nm = await reverseName(pickup.lat, pickup.lon);
    if (nm){
      pickup.text = nm;
      pickupInput.value = nm;
      locTxt.textContent = `Yer: ${nm}`;
    }else{
      locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)}`;
    }
    setStatus(statusEl,'Yer tapƒ±ldƒ± ‚úÖ');
    btnLoc.disabled = false;
  }, (err)=>{
    setStatus(statusEl,'GPS icaz…ôsi verilm…ôdi ‚ùå (Telefon location + icaz…ô verin)', false);
    btnLoc.disabled = false;
  }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
};

// Pickup search
let tmrPick=null;
pickupInput.addEventListener('input', (e)=>{
  clearTimeout(tmrPick);
  const q = e.target.value.trim();
  tmrPick = setTimeout(()=>{
    loadSuggestions(q, pickupSuggEl, (it)=>{
      pickup = { lat: it.lat, lon: it.lon, text: it.title };
      pickupInput.value = it.title;
      locTxt.textContent = `Yer: ${it.title}`;
      pickupSuggEl.innerHTML='';
    });
  }, 250);
});

// Destination search
let tmr=null;
document.getElementById('dest').addEventListener('input', (e)=>{
  clearTimeout(tmr);
  const q = e.target.value.trim();
  if (q.length < 3){ suggEl.innerHTML=''; drop=null; return; }
  tmr = setTimeout(()=>{
    loadSuggestions(q, suggEl, (it)=>{
      drop = { lat: it.lat, lon: it.lon, text: it.title };
      document.getElementById('dest').value = it.title;
      suggEl.innerHTML='';
    });
  }, 250);
});

// Cancel modal logic
const cancelBack = document.getElementById('cancelBack');
const cancelInfo = document.getElementById('cancelInfo');
const cancelReason = document.getElementById('cancelReason');
const cancelNote = document.getElementById('cancelNote');
let cancelRideId = null;

cancelReason.addEventListener('change', ()=>{
  cancelNote.style.display = (cancelReason.value === 'Dig…ôr‚Ä¶') ? 'block' : 'none';
});

document.getElementById('cancelNo').onclick = ()=>{ cancelBack.style.display='none'; cancelRideId=null; };

document.getElementById('cancelYes').onclick = async ()=>{
  if (!cancelRideId) return;
  try{
    setStatus(statusEl,'L…ôƒüv olunur‚Ä¶');
    await api('/api/passenger/cancel_ride', {method:'POST', body:{
      ride_id: cancelRideId,
      reason: cancelReason.value || null,
      note: cancelNote.value?.trim() || null
    }});
    cancelBack.style.display='none';
    cancelRideId=null;
    setStatus(statusEl,'L…ôƒüv edildi ‚úÖ');
    await refreshAll();
  }catch(e){
    setStatus(statusEl,'L…ôƒüv x…ôtasƒ±: '+(e.data?.reason||e.data?.error||e.message), false);
  }
};

function openCancel(id, txt){
  cancelRideId = id;
  cancelInfo.textContent = txt || `Sifari≈ü #${id}`;
  cancelReason.value='';
  cancelNote.value='';
  cancelNote.style.display='none';
  cancelBack.style.display='flex';
}

// Create ride
const btnCreate = document.getElementById('btnCreate');
btnCreate.onclick = async ()=>{
  if (!pickup) return setStatus(statusEl,'∆èvv…ôlc…ô yerinizi tapƒ±n (GPS).', false);
  if (!drop) return setStatus(statusEl,'Ged…ôc…ôyiniz yeri se√ßin.', false);
  try{
    setStatus(statusEl,'Sifari≈ü yaradƒ±lƒ±r‚Ä¶');
    const data = await api('/api/passenger/create_ride',{method:'POST',body:{
      pickup_lat: pickup.lat, pickup_lon: pickup.lon, pickup_text: pickup.text,
      drop_lat: drop.lat, drop_lon: drop.lon, drop_text: drop.text
    }});
    setStatus(statusEl,`Sifari≈ü #${data.ride?.id || ''} yaradƒ±ldƒ± ‚úÖ`);
    await refreshAll();
  }catch(e){
    setStatus(statusEl,'X…ôta: '+(e.data?.reason||e.data?.error||e.message), false);
  }
};

function driverLabel(r){
  const name = (r.driver_full_name || r.driver_first_name || '').trim();
  const uname = r.driver_username ? '@'+r.driver_username : '';
  const plate = r.driver_plate || r.plate || '';
  const car = [r.driver_car_make||r.car_make, r.driver_car_model||r.car_model, r.driver_car_color||r.car_color].filter(Boolean).join(' ');
  const phone = r.driver_phone || r.phone || '';

  return {
    title: name || uname || (r.driver_tg_id ? `tg:${r.driver_tg_id}` : 'S√ºr√ºc√º'),
    subtitle: [plate, car].filter(Boolean).join(' ‚Ä¢ ') || 'Profil tamamlanmayƒ±b',
    phone
  };
}

function renderActive(r){
  if (!r) { activeWrap.style.display='none'; activeWrap.innerHTML=''; return; }
  const st = String(r.status||'');
  const isActive = ['searching','assigned','started'].includes(st);
  if (!isActive) { activeWrap.style.display='none'; activeWrap.innerHTML=''; return; }

  let html = `<div class="driverCard"><div class="muted">Aktiv sifari≈ü: <b>#${r.id}</b> ‚Ä¢ ${st}</div>`;
  if (r.driver_id){
    const d = driverLabel(r);
    const initials = (d.title || 'S').trim().slice(0,1).toUpperCase();
    html += `
      <div class="driverTop" style="margin-top:10px">
        <div class="avatar">${initials}</div>
        <div>
          <div class="driverName">${escapeHtml(d.title)}</div>
          <div class="pill">${escapeHtml(d.subtitle)}</div>
          <div class="muted">Telegram: tg:${r.driver_tg_id || r.driver_id || ''}</div>
        </div>
      </div>
      <div class="btnRow">
        <button class="btnCall" id="btnCall">üìû Z…ông</button>
        <button class="btnMsg" id="btnMsg">üí¨ Mesaj</button>
        <button class="btnCancel" id="btnCancel">‚ùå L…ôƒüv et</button>
      </div>
    `;
  }else{
    html += `<div class="muted" style="margin-top:10px">Yaxƒ±n s√ºr√ºc√ºl…ôr…ô t…ôklif g√∂nd…ôrilir‚Ä¶</div>
             <div class="btnRow"><button class="btnCancel" id="btnCancel">‚ùå L…ôƒüv et</button></div>`;
  }
  html += `</div>`;
  activeWrap.innerHTML = html;
  activeWrap.style.display='block';

  const btnCancel2 = document.getElementById('btnCancel');
  if (btnCancel2) btnCancel2.onclick = ()=> openCancel(r.id, `${r.pickup_text||''} ‚Üí ${r.drop_text||''}`);

  const callBtn = document.getElementById('btnCall');
  if (callBtn) callBtn.onclick = ()=>{
    const phone = (r.driver_phone || r.phone || '').trim();
    if (phone) location.href = 'tel:'+phone;
    else Telegram.WebApp.showAlert('S√ºr√ºc√º telefon n√∂mr…ôsi profilind…ô yoxdur.');
  };

  const msgBtn = document.getElementById('btnMsg');
  if (msgBtn) msgBtn.onclick = ()=>{
    Telegram.WebApp.showAlert('Mesaj funksiyasƒ± n√∂vb…ôti m…ôrh…ôl…ôd…ô (ride chat).');
  };
}

function renderRides(list){
  ridesEl.innerHTML='';
  (list||[]).forEach((r)=>{
    const div = document.createElement('div');
    div.className='item';
    const drv = r.driver_id ? `S√ºr√ºc√º: ${(r.driver_full_name||r.driver_first_name||'')} (@${r.driver_username||'-'})` : 'S√ºr√ºc√º: ‚Äî';
    const canCancel = (r.status === 'searching' || r.status === 'assigned');
    div.innerHTML = `<b>#${r.id}</b> ‚Ä¢ ${r.status}<br>
      ${(r.pickup_text||'')} ‚Üí ${(r.drop_text||'')}<br>
      <span class="muted">${drv}</span>
    `;
    if (canCancel){
      const btn = document.createElement('button');
      btn.className='btnSmall';
      btn.textContent='L…ôƒüv et';
      btn.onclick = ()=> openCancel(r.id, `${r.pickup_text||''} ‚Üí ${r.drop_text||''}`);
      div.appendChild(document.createElement('div')).className='actions';
      div.querySelector('.actions').appendChild(btn);
    }
    ridesEl.appendChild(div);
  });
}

async function refreshAll(){
  try{
    const data = await api('/api/passenger/my_rides');
    const rides = data.rides || [];
    // active ride = first ride in active states
    const active = rides.find(r=>['searching','assigned','started'].includes(String(r.status||'')));
    renderActive(active);
    renderRides(rides);
  }catch(e){
    // If API fails, show minimal info
    setStatus(statusEl,'Sifari≈ül…ôri oxuma x…ôtasƒ±: '+(e.data?.reason||e.data?.error||e.message), false);
  }
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, (c)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

// Auto refresh every 2.5s (bolt-like)
refreshAll();
setInterval(refreshAll, 2500);
</script>
</body>
</html>
