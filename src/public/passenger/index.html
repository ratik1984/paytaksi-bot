<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi - S…ôrni≈üin</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="../assets/common.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{
      --bg:#ffffff;
      --panel:rgba(255,255,255,.92);
      --text:#0b0f14;
      --muted:#5b6572;
      --line:rgba(0,0,0,.10);
      --accent:#1bb66a;
      --danger:#b00020;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);overflow:hidden}

    /* Map */
    #mapWrap{position:relative;height:62vh;min-height:340px;background:#f3f4f6}
    #map{position:absolute;inset:0}
    .mapBtn{position:absolute;width:46px;height:46px;border-radius:999px;border:1px solid var(--line);background:var(--panel);backdrop-filter: blur(10px);color:var(--text);display:flex;align-items:center;justify-content:center;font-size:20px}
    .mapBtn:active{transform:scale(.98)}
    #btnMenu{left:14px;top:14px}
    #btnCenter{right:14px;top:14px}

    /* Bottom sheet */
    #sheet{position:absolute;left:0;right:0;bottom:0;height:48vh;
      background:var(--panel);
      border-top-left-radius:22px;border-top-right-radius:22px;border-top:1px solid var(--line);
      overflow:hidden;
      box-shadow: 0 -18px 60px rgba(0,0,0,.12);
    }
    #sheetHandle{width:44px;height:5px;border-radius:999px;background:rgba(0,0,0,.20);margin:10px auto 8px auto}
    #sheetInner{height:100%;overflow:auto;padding:0 14px 92px 14px}

    .title{font-weight:900;font-size:22px;margin:6px 2px}
    .muted{color:var(--muted);font-size:13px}
    .card{border:1px solid var(--line);border-radius:18px;padding:12px;margin:10px 0;background:#fff}
    input,button,select{width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);font-size:16px;background:#fff}
    button{border:none;background:var(--accent);color:#08110b;font-weight:900}
    button.secondary{background:#111;color:#fff}
    button.danger{background:var(--danger);color:#fff}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .list{margin-top:8px}
    .item{padding:10px;border:1px solid rgba(0,0,0,.12);border-radius:14px;margin:6px 0;background:#fff}
    .progress{height:8px;border-radius:999px;background:rgba(0,0,0,.08);overflow:hidden}
    .progress > div{height:100%;width:0%;background:var(--accent);transition:width .3s ease}

    /* bottom nav */
    #bottomNav{position:absolute;left:0;right:0;bottom:0;height:64px;background:var(--panel);border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(3,1fr);padding:6px 8px;gap:6px}
    .navBtn{border:none;background:transparent;color:var(--muted);border-radius:14px;font-size:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px}
    .navBtn.active{background:rgba(27,182,106,.12);color:var(--text)}
    .navIco{font-size:18px;line-height:18px}

    /* legacy wrapper */
    #legacyWrap{position:fixed;inset:0;background:#fff;overflow:auto;display:none;z-index:99999;padding:14px}
    #legacyWrap .closeLegacy{position:fixed;right:14px;top:14px;z-index:100000}
    .leaflet-control-attribution{display:none}
    .leaflet-control-zoom{display:none}

    /* Cancel reason modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:100001}
    .modal{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:14px;border:1px solid #e6e6e6}
    .modal h3{margin:6px 0 10px 0;font-size:18px}
    .modal .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .modal textarea{width:100%;min-height:72px;padding:10px;border-radius:12px;border:1px solid #d9d9d9;font-size:15px;resize:vertical}
    .btnGhost{background:#eee;color:#111}
  </style>
</head>
<body>
  <div id="mapWrap">
    <div id="map"></div>
    <button class="mapBtn" id="btnMenu" type="button">‚ò∞</button>
    <button class="mapBtn" id="btnCenter" type="button">üéØ</button>
  </div>

  <div id="sheet">
    <div id="sheetHandle"></div>
    <div id="sheetInner">
      <div class="muted" id="who2" style="margin:2px 2px 6px 2px"></div>

      <div id="stateIdle">
        <div class="title">Haraya?</div>
        <div class="card">
          <div class="row">
            <input id="dest2" placeholder="T…ôyinat yeri" autocomplete="off" />
            <div class="list" id="dest2List"></div>
            <button id="btnRequest2" type="button">Sifari≈ü et</button>
            <div class="muted" id="req2Status">GPS oxunur‚Ä¶</div>
          </div>
        </div>
      </div>

      <div id="stateSearching" style="display:none">
        <div class="title">S√ºr√ºc√º axtarƒ±lƒ±r</div>
        <div class="card">
          <div class="muted" id="searchSub">Yaxƒ±n s√ºr√ºc√ºl…ôr…ô t…ôklif g√∂nd…ôrilir‚Ä¶</div>
          <div class="progress" style="margin:10px 0"><div id="offerBar"></div></div>
          <div class="two">
            <button id="btnCancelRide2" class="danger" type="button">Gedi≈üi l…ôƒüv et</button>
            <button id="btnLegacy" class="secondary" type="button">Legacy panel</button>
          </div>
        </div>
      </div>

      <div id="stateAssigned" style="display:none">
        <div class="title">S√ºr√ºc√º yoldadƒ±r</div>
        <div class="card" id="driverCard2">
          <b id="drvName2">‚Äî</b>
          <div class="muted" id="drvCar2">‚Äî</div>
          <div class="muted" id="drvEta2">‚Äî</div>
          <div class="three" style="margin-top:10px">
            <button id="btnCall2" class="secondary" type="button">üìû Z…ông</button>
            <button id="btnMsg2" class="secondary" type="button">üí¨ Mesaj</button>
            <button id="btnCancelRide3" class="danger" type="button">L…ôƒüv et</button>
          </div>
          <div class="muted" style="margin-top:8px" id="drvContactHint">‚Äî</div>
        </div>
      </div>

      <div class="card" id="hintCard">
        <div class="muted">Pick-up avtomatik olaraq cari yeriniz g√∂t√ºr√ºl√ºr (GPS). ∆èg…ôr GPS icaz…ôsi yoxdursa, telefonun Location icaz…ôsini aktiv edin.</div>
      </div>
    </div>
  </div>

  <div id="bottomNav">
    <button class="navBtn active" id="navHome" type="button"><div class="navIco">üè†</div>∆èsas ekran</button>
    <button class="navBtn" id="navRides" type="button"><div class="navIco">üßæ</div>Gedi≈ü</button>
    <button class="navBtn" id="navAccount" type="button"><div class="navIco">üë§</div>Hesab</button>
  </div>

  <div id="legacyWrap">
    <button class="closeLegacy" id="btnCloseLegacy" type="button">‚úñ</button>
    <h2>PayTaksi üöï (Legacy)</h2>
    <div class="muted" id="who"></div>

    <div class="card">
      <div class="row">
        <button id="btnLoc">üìç M√∂vcud yerimi avtomatik tap</button>
        <div class="muted" id="locTxt">Yer: ‚Äî</div>

        <input id="pickupTxt" placeholder="M√∂vcud yeriniz (GPS il…ô avtomatik yazƒ±lacaq)" />
        <div class="list" id="pickupSuggestions"></div>

        <input id="dest" placeholder="Ged…ôc…ôyiniz yeri yazƒ±n (m…ôs: Nizami metro)" />
        <div class="list" id="suggestions"></div>

        <button id="btnCreate">üöï Sifari≈ü ver</button>
        <div class="muted" id="status">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <b>Son sifari≈ül…ôr</b>
      <div class="list" id="rides"></div>
    </div>
  </div>

  <!-- Cancel reason modal -->
  <div class="modalBack" id="cancelBack">
    <div class="modal">
      <h3>‚ùå Sifari≈üi l…ôƒüv et</h3>
      <div class="muted" id="cancelInfo">‚Äî</div>
      <div class="row" style="margin-top:10px">
        <select id="cancelReason">
          <option value="">S…ôb…ôb se√ßin</option>
          <option>S√ºr√ºc√º gecikir</option>
          <option>Fikrim d…ôyi≈üdi</option>
          <option>Yanlƒ±≈ü √ºnvan se√ßdim</option>
          <option>Qiym…ôt uyƒüun deyil</option>
          <option>Dig…ôr‚Ä¶</option>
        </select>
        <textarea id="cancelNote" placeholder="Dig…ôr s…ôb…ôb (ist…ôy…ô baƒülƒ±)" style="display:none"></textarea>
        <div class="two">
          <button id="cancelNo" class="btnGhost">Geri</button>
          <button id="cancelYes" class="danger" style="width:100%">L…ôƒüv et</button>
        </div>
        <div class="muted">L…ôƒüv etdikd…ô (…ôg…ôr s√ºr√ºc√º t…ôyin olunubsa) s√ºr√ºc√ºy…ô bildiri≈ü ged…ôc…ôk.</div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Telegram init
  try{ Telegram.WebApp.ready(); Telegram.WebApp.expand(); }catch(_){ }

  const u = (typeof tgUser === 'function') ? tgUser() : null;
  const who2 = document.getElementById('who2');
  const req2Status = document.getElementById('req2Status');
  const dest2 = document.getElementById('dest2');
  const dest2List = document.getElementById('dest2List');
  const btnRequest2 = document.getElementById('btnRequest2');
  const btnCenter = document.getElementById('btnCenter');
  const btnMenu = document.getElementById('btnMenu');
  const btnLegacy = document.getElementById('btnLegacy');
  const legacyWrap = document.getElementById('legacyWrap');
  const btnCloseLegacy = document.getElementById('btnCloseLegacy');

  const stateIdle = document.getElementById('stateIdle');
  const stateSearching = document.getElementById('stateSearching');
  const stateAssigned = document.getElementById('stateAssigned');
  const offerBar = document.getElementById('offerBar');
  const searchSub = document.getElementById('searchSub');

  const drvName2 = document.getElementById('drvName2');
  const drvCar2 = document.getElementById('drvCar2');
  const drvEta2 = document.getElementById('drvEta2');
  const btnCall2 = document.getElementById('btnCall2');
  const btnMsg2 = document.getElementById('btnMsg2');
  const btnCancelRide2 = document.getElementById('btnCancelRide2');
  const btnCancelRide3 = document.getElementById('btnCancelRide3');
  const drvContactHint = document.getElementById('drvContactHint');

  if (who2) who2.textContent = u ? `üë§ ${u.first_name||''} (@${u.username||'-'})` : 'Local dev mode';

  function setReq(msg, ok=true){
    if (!req2Status) return;
    req2Status.textContent = msg;
    req2Status.style.color = ok ? '' : 'crimson';
  }

  function uiShowState(name){
    if (!stateIdle) return;
    stateIdle.style.display = (name === 'idle') ? '' : 'none';
    stateSearching.style.display = (name === 'searching') ? '' : 'none';
    stateAssigned.style.display = (name === 'assigned') ? '' : 'none';
  }

  // Map
  let map = null;
  let pickMarker = null;
  let pickCircle = null;
  let dropMarker = null;
  let drvMarker = null;
  let line = null;

  function ensureMap(){
    if (map) return map;
    map = L.map('map', { zoomControl:false, attributionControl:false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
    map.setView([40.4093, 49.8671], 13);
    return map;
  }

  function setPickupMarker(lat, lon){
    const m = ensureMap();
    if (!m || !isFinite(lat) || !isFinite(lon)) return;
    const ll = [lat, lon];
    if (!pickMarker) pickMarker = L.circleMarker(ll, { radius:8, weight:2, fillOpacity:1 }).addTo(m);
    else pickMarker.setLatLng(ll);

    if (!pickCircle) pickCircle = L.circle(ll, { radius:60, weight:1, fillOpacity:0.12 }).addTo(m);
    else pickCircle.setLatLng(ll);
  }

  function setDropMarker(lat, lon){
    const m = ensureMap();
    if (!m || !isFinite(lat) || !isFinite(lon)) return;
    const ll = [lat, lon];
    if (!dropMarker) dropMarker = L.marker(ll).addTo(m);
    else dropMarker.setLatLng(ll);
  }

  function setDriverMarker(lat, lon){
    const m = ensureMap();
    if (!m || !isFinite(lat) || !isFinite(lon)) return;
    const ll = [lat, lon];
    if (!drvMarker) drvMarker = L.marker(ll).addTo(m);
    else drvMarker.setLatLng(ll);
  }

  function drawLine(points){
    try{
      const m = ensureMap();
      if (!m) return;
      if (line){ m.removeLayer(line); line = null; }
      if (!points || points.length < 2) return;
      line = L.polyline(points, { weight:5, opacity:0.9 }).addTo(m);
      m.fitBounds(line.getBounds(), { padding:[40,40] });
    }catch(_){ }
  }

  let pickup = null;
  let drop = null;

  async function reverseName(lat, lon){
    try{
      const url = new URL('/api/reverse', location.origin);
      url.searchParams.set('lat', lat);
      url.searchParams.set('lon', lon);
      const r = await fetch(url);
      const j = await r.json();
      if (j.ok && (j.name || j.display_name)) return (j.name || j.display_name);
    }catch(_){ }
    return null;
  }

  function haversineKm(a, b) {
    const R = 6371;
    const dLat = (b.lat - a.lat) * Math.PI / 180;
    const dLon = (b.lon - a.lon) * Math.PI / 180;
    const lat1 = a.lat * Math.PI / 180;
    const lat2 = b.lat * Math.PI / 180;
    const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(x));
  }

  function computeEtaMin(driverLat, driverLon, pickLat, pickLon){
    try{
      if (!isFinite(driverLat) || !isFinite(driverLon) || !isFinite(pickLat) || !isFinite(pickLon)) return null;
      const km = haversineKm({lat:driverLat, lon:driverLon}, {lat:pickLat, lon:pickLon});
      const speedKmh = 25;
      return Math.max(1, Math.round((km / speedKmh) * 60));
    }catch(_){ return null; }
  }

  async function ensurePickup(){
    if (pickup) return pickup;
    setReq('GPS oxunur‚Ä¶');
    return new Promise((resolve)=>{
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        let text = 'M…ônim yerim';
        const nm = await reverseName(lat, lon);
        if (nm) text = nm;
        pickup = { lat, lon, text };
        setPickupMarker(lat, lon);
        try{ ensureMap().setView([lat, lon], 16); }catch(_){ }
        setReq('Hazƒ±r ‚úÖ');
        resolve(pickup);
      }, ()=>{
        setReq('GPS icaz…ôsi yoxdur. Location icaz…ôsini aktiv edin.', false);
        resolve(null);
      }, { enableHighAccuracy:true, timeout:12000 });
    });
  }

  // Autocomplete (places)
  async function loadSuggestions(q, listEl, onPick){
    if (!q || q.length < 3){ listEl.innerHTML=''; return; }
    try{
      const url = new URL('/api/places', location.origin);
      url.searchParams.set('q', q);
      if (pickup){ url.searchParams.set('lat', pickup.lat); url.searchParams.set('lon', pickup.lon); }
      const r = await fetch(url);
      const data = await r.json();
      listEl.innerHTML = '';
      (data.items||[]).forEach((it)=>{
        const div = document.createElement('div');
        div.className='item';
        div.textContent = it.title;
        div.onclick = ()=> onPick(it);
        listEl.appendChild(div);
      });
    }catch(_){ listEl.innerHTML=''; }
  }

  let tmr2 = null;
  if (dest2){
    dest2.addEventListener('input', (e)=>{
      clearTimeout(tmr2);
      const q = String(e.target.value||'').trim();
      if (q.length < 3){ dest2List.innerHTML=''; drop=null; return; }
      tmr2 = setTimeout(()=>{
        loadSuggestions(q, dest2List, (it)=>{
          drop = { lat: Number(it.lat), lon: Number(it.lon), text: it.title };
          dest2.value = it.title;
          dest2List.innerHTML='';
          setDropMarker(drop.lat, drop.lon);
          if (pickup) drawLine([[pickup.lat,pickup.lon],[drop.lat,drop.lon]]);
        });
      }, 250);
    });
  }

  async function createRide(){
    const p = await ensurePickup();
    if (!p) return;
    if (!drop){ setReq('T…ôyinat se√ßin.', false); return; }
    try{
      setReq('Sifari≈ü yaradƒ±lƒ±r‚Ä¶');
      const km = haversineKm({lat:p.lat, lon:p.lon}, {lat:drop.lat, lon:drop.lon});
      const data = await api('/api/passenger/create_ride', { method:'POST', body:{
        pickup_lat: p.lat, pickup_lon: p.lon, pickup_text: p.text,
        drop_lat: drop.lat, drop_lon: drop.lon, drop_text: drop.text,
        distance_km: km
      }});
      __activeRideId = Number(data.ride?.id || 0) || null;
      uiShowState('searching');
      setReq(`Sifari≈ü #${data.ride.id} yaradƒ±ldƒ±.`);
      try{ await loadLegacyRides(); }catch(_){ }
    }catch(e){
      setReq('X…ôta: '+(e?.data?.reason || e?.data?.error || e.message), false);
    }
  }

  if (btnRequest2) btnRequest2.onclick = createRide;

  if (btnMenu) btnMenu.onclick = ()=>{ legacyWrap.style.display='block'; };
  if (btnLegacy) btnLegacy.onclick = ()=>{ legacyWrap.style.display='block'; };
  if (btnCloseLegacy) btnCloseLegacy.onclick = ()=>{ legacyWrap.style.display='none'; };

  if (btnCenter) btnCenter.onclick = ()=>{
    const m = ensureMap();
    if (pickup && m) m.setView([pickup.lat, pickup.lon], 16);
  };

  let __lastAssignedRide = null;

  function openDriverCall(ride){
    const phone = String(ride?.driver_phone||'').trim();
    if (!phone) return alert('S√ºr√ºc√ºn√ºn telefon n√∂mr…ôsi sistemd…ô yoxdur. (Admin paneld…ôn s√ºr√ºc√ºy…ô telefon …ôlav…ô edin)');
    try{ location.href = `tel:${phone}`; }catch(_){ alert(phone); }
  }

  function openDriverMsg(ride){
    // Prefer tg user id; fallback to username
    const tgId = ride?.driver_tg_id ? String(ride.driver_tg_id) : '';
    const uname = ride?.driver_username ? String(ride.driver_username) : '';
    if (tgId) {
      try{ location.href = `tg://user?id=${encodeURIComponent(tgId)}`; return; }catch(_){ }
    }
    if (uname) {
      try{ location.href = `https://t.me/${encodeURIComponent(uname)}`; return; }catch(_){ }
    }
    alert('S√ºr√ºc√ºy…ô mesaj √º√ß√ºn Telegram m…ôlumatƒ± tapƒ±lmadƒ±.');
  }

  if (btnCall2) btnCall2.onclick = ()=> openDriverCall(__lastAssignedRide);
  if (btnMsg2) btnMsg2.onclick = ()=> openDriverMsg(__lastAssignedRide);

  // ---- Cancel modal helpers
  const cancelBack = document.getElementById('cancelBack');
  const cancelInfo = document.getElementById('cancelInfo');
  const cancelReason = document.getElementById('cancelReason');
  const cancelNote = document.getElementById('cancelNote');
  const cancelNo = document.getElementById('cancelNo');
  const cancelYes = document.getElementById('cancelYes');

  cancelReason.addEventListener('change', ()=>{
    const v = String(cancelReason.value||'');
    cancelNote.style.display = (v && v.startsWith('Dig…ôr')) ? '' : 'none';
  });

  function openCancelModal(ride){
    return new Promise((resolve)=>{
      cancelInfo.innerHTML = `<b>#${ride.id}</b> ‚Ä¢ ${(ride.pickup_text||'')} ‚Üí ${(ride.drop_text||'')}`;
      cancelReason.value = '';
      cancelNote.value = '';
      cancelNote.style.display = 'none';
      cancelBack.style.display = 'flex';

      const close = (val)=>{
        cancelBack.style.display = 'none';
        cancelNo.onclick = null;
        cancelYes.onclick = null;
        resolve(val);
      };

      cancelNo.onclick = ()=> close(null);
      cancelBack.onclick = (e)=>{ if (e.target === cancelBack) close(null); };
      cancelYes.onclick = ()=>{
        const sel = String(cancelReason.value||'').trim();
        if (!sel) { alert('S…ôb…ôb se√ßin.'); return; }
        let text = sel;
        if (sel.startsWith('Dig…ôr')) {
          const note = String(cancelNote.value||'').trim();
          if (note) text = note;
        }
        close(text.slice(0,200));
      };
    });
  }

  // ---- Active ride restore/poll (FIX: after re-open user sees active ride)
  let __activeRideId = null;

  function renderActiveRide(r){
    if (!r){
      __activeRideId = null;
      offerBar && (offerBar.style.width='0%');
      uiShowState('idle');
      return;
    }

    __activeRideId = Number(r.id);

    // Ensure pickup from ride (so re-open works even if GPS is slow)
    const rPickLat = Number(r.pickup_lat);
    const rPickLon = Number(r.pickup_lon);
    if (isFinite(rPickLat) && isFinite(rPickLon)){
      pickup = { lat: rPickLat, lon: rPickLon, text: r.pickup_text || 'Pick-up' };
      setPickupMarker(rPickLat, rPickLon);
    }

    const rDropLat = Number(r.drop_lat);
    const rDropLon = Number(r.drop_lon);
    if (isFinite(rDropLat) && isFinite(rDropLon)){
      drop = { lat: rDropLat, lon: rDropLon, text: r.drop_text || 'T…ôyinat' };
      setDropMarker(rDropLat, rDropLon);
    }

    if (pickup && drop) drawLine([[pickup.lat,pickup.lon],[drop.lat,drop.lon]]);

    if (String(r.status) === 'searching'){
      uiShowState('searching');
      const hasOffer = r.offered_driver_id != null;
      if (hasOffer){
        searchSub && (searchSub.textContent = 'S√ºr√ºc√ºn√ºn sifari≈üi t…ôsdiql…ôm…ôsi g√∂zl…ônilir');
      } else {
        searchSub && (searchSub.textContent = 'Yaxƒ±n s√ºr√ºc√ºl…ôr…ô t…ôklif g√∂nd…ôrilir‚Ä¶');
      }
      // Simple progress animation
      const exp = r.offer_expires_at ? new Date(r.offer_expires_at).getTime() : 0;
      const now = Date.now();
      const total = 20 * 1000;
      let pct = 0;
      if (exp) pct = Math.max(0, Math.min(1, (exp - now) / total));
      offerBar && (offerBar.style.width = Math.round(pct*100) + '%');
      return;
    }

    if (String(r.status) === 'assigned' || String(r.status) === 'started'){
      uiShowState('assigned');
      __lastAssignedRide = r;
      const name = (String(r.driver_first_name||'' ).trim() || (r.driver_username ? ' + r.driver_username : (r.driver_tg_id ? 'tg:' + r.driver_tg_id : 'S√ºr√ºc√º')));
      const plate = (r.driver_plate || '').trim();
      const car = [r.driver_car_make, r.driver_car_model].filter(Boolean).join(' ');
      const color = (r.driver_car_color || '').trim();
      drvName2 && (drvName2.textContent = name + (plate ? ` ‚Ä¢ ${plate}` : ''));
      const carLine = [car, color, r.driver_car_year].filter(Boolean).join(' ‚Ä¢ ');
      drvCar2 && (drvCar2.textContent = carLine || 'Profil tamamlanmayƒ±b');

      // Contact hint
      const phone = String(r.driver_phone||'').trim();
      const tgHint = r.driver_username ? `@${r.driver_username}` : (r.driver_tg_id ? `tg:${r.driver_tg_id}` : '');
      if (drvContactHint) {
        drvContactHint.textContent = phone ? `Telefon: ${phone} ${tgHint ? '‚Ä¢ ' + tgHint : ''}` : (tgHint ? `Telegram: ${tgHint}` : '∆èlaq…ô m…ôlumatƒ± yoxdur');
      }

      const dlat = Number(r.driver_last_lat);
      const dlon = Number(r.driver_last_lon);
      if (isFinite(dlat) && isFinite(dlon) && pickup){
        setDriverMarker(dlat, dlon);
        const eta = computeEtaMin(dlat, dlon, pickup.lat, pickup.lon);
        drvEta2 && (drvEta2.textContent = eta ? `${eta} d…ôqiq…ôy…ô √ßatƒ±r` : '‚Äî');

        // Bolt-like: show driver -> pickup line when assigned
        try{ drawLine([[dlat, dlon],[pickup.lat, pickup.lon]]); }catch(_){ }
      } else {
        drvEta2 && (drvEta2.textContent = '‚Äî');
      }
      offerBar && (offerBar.style.width='100%');
      return;
    }

    // completed/cancelled -> idle
    uiShowState('idle');
  }

  async function pollActiveRide(){
    try{
      const data = await api('/api/passenger/my_rides');
      const rides = data.rides || [];
      const active = rides.find(r => !['completed','cancelled'].includes(String(r.status)));
      renderActiveRide(active || null);
    }catch(_){ }
  }

  async function cancelActiveRide(){
    if (!__activeRideId) return;
    try{
      // open modal with latest ride info
      let reason = null;
      try{
        const data = await api('/api/passenger/my_rides');
        const ride = (data.rides||[]).find(x=>Number(x.id)===Number(__activeRideId));
        if (ride) reason = await openCancelModal(ride);
      }catch(_){ }
      await api('/api/passenger/cancel_ride', { method:'POST', body:{ ride_id: __activeRideId, reason } });
      await pollActiveRide();
      try{ await loadLegacyRides(); }catch(_){ }
    }catch(e){
      alert('L…ôƒüv x…ôtasƒ±: '+(e?.data?.error || e?.data?.reason || e.message));
    }
  }

  if (btnCancelRide2) btnCancelRide2.onclick = cancelActiveRide;
  if (btnCancelRide3) btnCancelRide3.onclick = cancelActiveRide;

  // Start
  ensureMap();
  ensurePickup(); // best-effort
  pollActiveRide();
  setInterval(pollActiveRide, 3000);

  // =====================
  // Legacy panel logic (kept for compatibility)
  // =====================
  const who = document.getElementById('who');
  const statusEl = document.getElementById('status');
  const locTxt = document.getElementById('locTxt');
  const ridesEl = document.getElementById('rides');
  const suggEl = document.getElementById('suggestions');
  const pickupInput = document.getElementById('pickupTxt');
  const pickupSuggEl = document.getElementById('pickupSuggestions');
  const destLegacy = document.getElementById('dest');

  if (who) who.textContent = u ? `ƒ∞stifad…ô√ßi: ${u.first_name||''} (@${u.username||'-'})` : 'Local dev mode';

  function setStatus(el, msg, ok=true){
    if (!el) return;
    el.textContent = msg;
    el.style.color = ok ? '' : 'crimson';
  }

  let legacyDrop = null;

  document.getElementById('btnLoc').onclick = async ()=>{
    setStatus(statusEl,'GPS sorƒüusu‚Ä¶');
    const p = await ensurePickup();
    if (!p) return;
    locTxt.textContent = `Yer: ${p.text}`;
    pickupInput.value = p.text;
    setStatus(statusEl,'Yer tapƒ±ldƒ± ‚úÖ');
  };

  let tmrPick = null;
  pickupInput.addEventListener('input', (e)=>{
    clearTimeout(tmrPick);
    const q = e.target.value.trim();
    tmrPick = setTimeout(()=>{
      loadSuggestions(q, pickupSuggEl, (it)=>{
        pickup = { lat: Number(it.lat), lon: Number(it.lon), text: it.title };
        pickupInput.value = it.title;
        locTxt.textContent = `Yer: ${it.title}`;
        pickupSuggEl.innerHTML='';
        setPickupMarker(pickup.lat, pickup.lon);
      });
    }, 250);
  });

  let tmrLegacy = null;
  destLegacy.addEventListener('input', (e)=>{
    clearTimeout(tmrLegacy);
    const q = e.target.value.trim();
    if (q.length < 3){ suggEl.innerHTML=''; legacyDrop=null; return; }
    tmrLegacy = setTimeout(()=>{
      loadSuggestions(q, suggEl, (it)=>{
        legacyDrop = { lat: Number(it.lat), lon: Number(it.lon), text: it.title };
        destLegacy.value = it.title;
        suggEl.innerHTML='';
      });
    }, 250);
  });

  document.getElementById('btnCreate').onclick = async ()=>{
    const p = await ensurePickup();
    if (!p) return setStatus(statusEl,'∆èvv…ôlc…ô yerinizi tapƒ±n (GPS).', false);
    if (!legacyDrop) return setStatus(statusEl,'Ged…ôc…ôyiniz yeri se√ßin.', false);
    try{
      setStatus(statusEl,'Sifari≈ü yaradƒ±lƒ±r‚Ä¶');
      const km = haversineKm({lat:p.lat, lon:p.lon}, {lat:legacyDrop.lat, lon:legacyDrop.lon});
      const data = await api('/api/passenger/create_ride', { method:'POST', body:{
        pickup_lat: p.lat, pickup_lon: p.lon, pickup_text: p.text,
        drop_lat: legacyDrop.lat, drop_lon: legacyDrop.lon, drop_text: legacyDrop.text,
        distance_km: km
      }});
      setStatus(statusEl,`Sifari≈ü #${data.ride.id} yaradƒ±ldƒ±. T…ôxmini qiym…ôt: ${data.ride.fare} AZN`);
      await loadLegacyRides();
      await pollActiveRide();
    }catch(e){
      setStatus(statusEl,'X…ôta: '+(e?.data?.reason || e?.data?.error || e.message), false);
    }
  };

  async function loadLegacyRides(){
    if (!ridesEl) return;
    try{
      const data = await api('/api/passenger/my_rides');
      const rides = data.rides || [];
      ridesEl.innerHTML = '';
      rides.forEach((r)=>{
        const div = document.createElement('div');
        div.className='item';
        div.textContent = `#${r.id} ‚Ä¢ ${r.pickup_text||''} ‚Üí ${r.drop_text||''} ‚Ä¢ ${r.status}`;
        ridesEl.appendChild(div);
      });
    }catch(_){ }
  }

  // initial legacy list
  loadLegacyRides();
  setInterval(loadLegacyRides, 6000);
})();
</script>
</body>
</html>
