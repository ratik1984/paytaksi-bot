<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi - S…ôrni≈üin</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="../assets/common.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:14px}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:12px;margin:10px 0}
    input,button,select{width:100%;padding:10px;border-radius:12px;border:1px solid #d9d9d9;font-size:16px}
    button{border:none;background:#111;color:#fff}
    .row{display:grid;grid-template-columns:1fr;gap:8px}
    .muted{color:#666;font-size:13px}
    .list{margin-top:8px}
    .item{padding:8px;border:1px dashed #ddd;border-radius:12px;margin:6px 0}
    .btnSmall{padding:8px 10px;border-radius:10px;border:0;background:#b00020;color:#fff;font-size:14px;width:auto}
    .actions{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Cancel reason modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:14px;border:1px solid #e6e6e6}
    .modal h3{margin:6px 0 10px 0;font-size:18px}
    .modal .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .modal textarea{width:100%;min-height:72px;padding:10px;border-radius:12px;border:1px solid #d9d9d9;font-size:15px;resize:vertical}
    .btnGhost{background:#eee;color:#111}
  </style>
</head>
<body>
  <h2>PayTaksi üöï</h2>
  <div class="muted" id="who"></div>

  <div class="card">
    <div class="row">
      <button id="btnLoc">üìç M√∂vcud yerimi avtomatik tap</button>
      <div class="muted" id="locTxt">Yer: ‚Äî</div>

      <input id="pickupTxt" placeholder="M√∂vcud yeriniz (GPS il…ô avtomatik yazƒ±lacaq)" />
      <div class="list" id="pickupSuggestions"></div>

      <input id="dest" placeholder="Ged…ôc…ôyiniz yeri yazƒ±n (m…ôs: Nizami metro)" />
      <div class="list" id="suggestions"></div>

      <button id="btnCreate">üöï Sifari≈ü ver</button>
      <div class="muted" id="status">‚Äî</div>
    </div>
  </div>

  <div class="card">
    <b>Son sifari≈ül…ôr</b>
    <div class="list" id="rides"></div>
  </div>

  <!-- Cancel reason modal -->
  <div class="modalBack" id="cancelBack">
    <div class="modal">
      <h3>‚ùå Sifari≈üi l…ôƒüv et</h3>
      <div class="muted" id="cancelInfo">‚Äî</div>
      <div class="row" style="margin-top:10px">
        <select id="cancelReason">
          <option value="">S…ôb…ôb se√ßin</option>
          <option>S√ºr√ºc√º gecikir</option>
          <option>Fikrim d…ôyi≈üdi</option>
          <option>Yanlƒ±≈ü √ºnvan se√ßdim</option>
          <option>Qiym…ôt uyƒüun deyil</option>
          <option>Dig…ôr‚Ä¶</option>
        </select>
        <textarea id="cancelNote" placeholder="Dig…ôr s…ôb…ôb (ist…ôy…ô baƒülƒ±)" style="display:none"></textarea>
        <div class="two">
          <button id="cancelNo" class="btnGhost">Geri</button>
          <button id="cancelYes" class="btnSmall" style="width:100%">L…ôƒüv et</button>
        </div>
        <div class="muted">L…ôƒüv etdikd…ô (…ôg…ôr s√ºr√ºc√º t…ôyin olunubsa) s√ºr√ºc√ºy…ô bildiri≈ü ged…ôc…ôk.</div>
      </div>
    </div>
  </div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const who = document.getElementById('who');
const statusEl = document.getElementById('status');
const locTxt = document.getElementById('locTxt');
const ridesEl = document.getElementById('rides');
const suggEl = document.getElementById('suggestions');
const pickupInput = document.getElementById('pickupTxt');
const pickupSuggEl = document.getElementById('pickupSuggestions');

const u = tgUser();
who.textContent = u ? `ƒ∞stifad…ô√ßi: ${u.first_name || ''} (@${u.username||'-'})` : 'Local dev mode';

let lastDistanceKm = 0;

function haversineKm(a, b) {
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLon = (b.lon - a.lon) * Math.PI / 180;
  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;
  const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(x));
}
function calcFare(distanceKm) {
  const base = 3.50;
  if (!distanceKm || distanceKm <= 0) return base;
  if (distanceKm <= 3) return base;
  return base + (distanceKm - 3) * 0.40;
}
function updateFareUI() {
  const el = document.getElementById('fareInfo');
  if (!el) return;
  if (!pickup || !drop) { el.textContent = ''; lastDistanceKm = 0; return; }
  const km = haversineKm({lat:pickup.lat, lon:pickup.lon}, {lat:drop.lat, lon:drop.lon});
  lastDistanceKm = km;
  const fare = calcFare(km);
  el.textContent = `M…ôsaf…ô: ${km.toFixed(2)} km ‚Ä¢ T…ôxmini m…ôbl…ôƒü: ${fare.toFixed(2)} AZN`;
}

let pickup = null;
let drop = null;

document.getElementById('btnLoc').onclick = () => {
  setStatus(statusEl,'GPS sorƒüusu‚Ä¶');
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    pickup = { lat: pos.coords.latitude, lon: pos.coords.longitude, text: 'M…ônim yerim' };
    locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)} (tapƒ±lƒ±r‚Ä¶)`;

    // M√∂vcud yerin adƒ±nƒ± tap (reverse geocode)
    try{
      const url = new URL('/api/reverse', location.origin);
      url.searchParams.set('lat', pickup.lat);
      url.searchParams.set('lon', pickup.lon);
      const r = await fetch(url);
      const j = await r.json();
      if (j.ok && (j.name || j.display_name)){
        pickup.text = j.name || j.display_name;
        locTxt.textContent = `Yer: ${pickup.text}`;
        pickupInput.value = pickup.text;
      } else {
        locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)}`;
        pickupInput.value = '';
      }
    }catch(e){
      locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)}`;
      pickupInput.value = '';
    }

    setStatus(statusEl,'Yer tapƒ±ldƒ± ‚úÖ');
  }, (err)=>{
    setStatus(statusEl,'GPS icaz…ôsi verilm…ôdi ‚ùå', false);
  }, { enableHighAccuracy:true, timeout:10000 });
};

// --- Autocomplete helper
async function loadSuggestions(q, listEl, onPick){
  if (!q || q.length < 3){ listEl.innerHTML=''; return; }
  try{
    const url = new URL('/api/places', location.origin);
    url.searchParams.set('q', q);
    if (pickup){ url.searchParams.set('lat', pickup.lat); url.searchParams.set('lon', pickup.lon); }
    const r = await fetch(url);
    const data = await r.json();
    listEl.innerHTML = '';
    (data.items||[]).forEach((it)=>{
      const div = document.createElement('div');
      div.className='item';
      div.textContent = it.title;
      div.onclick = ()=> onPick(it);
      listEl.appendChild(div);
    });
  }catch(e){ listEl.innerHTML=''; }
}

let tmrPick = null;
pickupInput.addEventListener('input', (e)=>{
  clearTimeout(tmrPick);
  const q = e.target.value.trim();
  tmrPick = setTimeout(()=>{
    loadSuggestions(q, pickupSuggEl, (it)=>{
      // Allow user to override pickup by selecting a nearby place
      pickup = { lat: it.lat, lon: it.lon, text: it.title };
      pickupInput.value = it.title;
      locTxt.textContent = `Yer: ${it.title}`;
      pickupSuggEl.innerHTML='';
    });
  }, 250);
});


let tmr = null;
document.getElementById('dest').addEventListener('input', (e)=>{
  clearTimeout(tmr);
  const q = e.target.value.trim();
  if (q.length < 3){ suggEl.innerHTML=''; drop=null; return; }
  tmr = setTimeout(async ()=>{
    loadSuggestions(q, suggEl, (it)=>{
      drop = { lat: it.lat, lon: it.lon, text: it.title };
      document.getElementById('dest').value = it.title;
      suggEl.innerHTML='';
    });
  }, 250);
});

document.getElementById('btnCreate').onclick = async ()=>{
  if (!pickup) return setStatus(statusEl,'∆èvv…ôlc…ô yerinizi tapƒ±n (GPS).', false);
  if (!drop) return setStatus(statusEl,'Ged…ôc…ôyiniz yeri se√ßin.', false);
  try{
    setStatus(statusEl,'Sifari≈ü yaradƒ±lƒ±r‚Ä¶');
    const data = await api('/api/passenger/create_ride',{method:'POST',body:{
      pickup_lat: pickup.lat, pickup_lon: pickup.lon, pickup_text: pickup.text,
      drop_lat: drop.lat, drop_lon: drop.lon, drop_text: drop.text,
      distance_km: lastDistanceKm
    }});
    setStatus(statusEl,`Sifari≈ü #${data.ride.id} yaradƒ±ldƒ±. T…ôxmini qiym…ôt: ${data.ride.fare} AZN (komissiya: ${data.ride.commission} AZN)`);
    await loadRides();
  }catch(e){
    setStatus(statusEl,'X…ôta: '+(e.data?.reason||e.data?.error||e.message), false);
  }
};

async function loadRides(){
  try{
    const data = await api('/api/passenger/my_rides');
    ridesEl.innerHTML='';
    (data.rides||[]).forEach((r)=>{
      const div = document.createElement('div');
      div.className='item';
      const drv = r.driver_id ? `S√ºr√ºc√º: ${r.driver_name || ''} (@${r.driver_username||'-'})` : 'S√ºr√ºc√º: ‚Äî';
      const canCancel = (r.status === 'searching' || r.status === 'assigned');
      const canViewChat = (r.driver_id && ['assigned','started','completed','cancelled'].includes(String(r.status)));
      const canSendChat = (r.driver_id && (r.status === 'assigned' || r.status === 'started'));
      const canCall = (r.driver_id && (r.status === 'assigned' || r.status === 'started'));
      div.innerHTML = `<b>#${r.id}</b> ‚Ä¢ ${r.status}<br>
        ${r.pickup_text||''} ‚Üí ${r.drop_text||''}<br>
        M…ôsaf…ô: ${Number(r.distance_km).toFixed(2)} km ‚Ä¢ Qiym…ôt: ${r.fare} AZN<br>
        <span class="muted">${drv}</span>
        ${canViewChat ? `
          <div class="actions" style="margin-top:8px">
            <button class="btnSmall" data-chat="${r.id}">${canSendChat ? 'üí¨ Yazƒ±≈üma' : 'üìú Yazƒ±≈üma (arxiv)'}</button>
            ${canCall ? `<button class="btnSmall" data-call="${r.id}">üìû S√ºr√ºc√ºy…ô z…ông</button>` : ''}
          </div>
          <div class="card" data-chatbox="${r.id}" style="display:none;margin-top:8px;border-radius:12px;padding:10px">
            <div class="muted" style="margin-bottom:6px">${canSendChat ? 'Yazƒ±≈üma yalnƒ±z s√ºr√ºc√º q…ôbul ed…ônd…ôn sonra aktiv olur.' : 'Bu yazƒ±≈üma arxivdir (yalnƒ±z oxu).'}</div>
            <div data-msglist style="max-height:220px;overflow:auto;border:1px dashed #ddd;border-radius:12px;padding:8px"></div>
            ${canSendChat ? `
              <div class="row" style="margin-top:8px">
                <input data-msgtext placeholder="Mesaj yaz‚Ä¶" />
                <button class="btnSmall" data-send>G√∂nd…ôr</button>
              </div>
            ` : ''}
          </div>
        ` : ''}
        ${canCancel ? `<div class="actions"><button class="btnSmall" data-cancel="${r.id}">‚ùå L…ôƒüv et</button><span class="muted">(Sifari≈üin l…ôƒüv edilm…ôsi s√ºr√ºc√ºy…ô bildiril…ôc…ôk)</span></div>` : ''}`;
      ridesEl.appendChild(div);

      if (canCancel){
        const btn = div.querySelector('[data-cancel]');
        btn.onclick = async ()=>{
          const reason = await openCancelModal(r);
          if (reason === null) return;
          try{
            btn.disabled = true;
            await api('/api/passenger/cancel_ride',{method:'POST',body:{ride_id: Number(r.id), reason}});
            setStatus(statusEl,`Sifari≈ü #${r.id} l…ôƒüv edildi ‚úÖ`);
            await loadRides();
          }catch(e){
            setStatus(statusEl,'L…ôƒüv edil…ô bilm…ôdi: '+(e.data?.error||e.message), false);
          }finally{ btn.disabled = false; }
        };
      }

      if (canViewChat){
        // Call (Telegram) - only while active
        const bCall = div.querySelector('[data-call]');
        if (bCall) {
          bCall.onclick = ()=>{
            openTelegramUser({ tg_id: r.driver_tg_id, username: r.driver_username });
          };
        }

        // Chat toggle
        const bChat = div.querySelector('[data-chat]');
        const box = div.querySelector('[data-chatbox]');
        const list = box.querySelector('[data-msglist]');
        const input = box.querySelector('[data-msgtext]');
        const bSend = box.querySelector('[data-send]');

        let chatTimer = null;
        let lastRendered = 0;

        async function refreshChat(){
          try{
            const data = await api('/api/passenger/ride_messages?ride_id='+encodeURIComponent(r.id));
            const msgs = data.messages || [];
            if (!msgs.length){
              list.innerHTML = '<div class="muted">H…ôl…ô mesaj yoxdur.</div>';
              return;
            }
            // Render only if changed
            const lastId = msgs[msgs.length-1].id || 0;
            if (lastId === lastRendered) return;
            lastRendered = lastId;
            list.innerHTML = '';
            msgs.forEach((m)=>{
              const mine = m.sender_role === 'passenger';
              const divm = document.createElement('div');
              divm.style.margin = '6px 0';
              divm.style.textAlign = mine ? 'right' : 'left';
              divm.innerHTML = `<span style="display:inline-block;max-width:88%;padding:8px 10px;border-radius:12px;border:1px solid #e6e6e6;${mine?'background:#111;color:#fff;border-color:#111':''}">${escapeHtml(m.message)}</span>`;
              list.appendChild(divm);
            });
            list.scrollTop = list.scrollHeight;
          }catch(e){}
        }

        bChat.onclick = async ()=>{
          const open = box.style.display !== 'none';
          if (open){
            box.style.display = 'none';
            bChat.textContent = canSendChat ? 'üí¨ Yazƒ±≈üma' : 'üìú Yazƒ±≈üma (arxiv)';
            if (chatTimer) { clearInterval(chatTimer); chatTimer = null; }
            return;
          }
          box.style.display = '';
          bChat.textContent = '‚úñ Baƒüla';
          await refreshChat();
          chatTimer = setInterval(refreshChat, 3000);
        };

        if (bSend){
          bSend.onclick = async ()=>{
            const text = String(input.value||'').trim();
            if (!text) return;
            bSend.disabled = true;
            try{
              await api('/api/passenger/send_message',{method:'POST',body:{ride_id:Number(r.id), text}});
              input.value='';
              await refreshChat();
            }catch(e){
              alert('X…ôta: '+(e.data?.error||e.data?.reason||e.message));
            }finally{ bSend.disabled = false; }
          };
        }
      }
    });
    if (!data.rides?.length) ridesEl.innerHTML = '<div class="muted">H…ôl…ô sifari≈ü yoxdur.</div>';
  }catch(e){}
}

function escapeHtml(s){
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}
loadRides();
setInterval(loadRides, 4000);

// ---- Cancel modal helpers
const cancelBack = document.getElementById('cancelBack');
const cancelInfo = document.getElementById('cancelInfo');
const cancelReason = document.getElementById('cancelReason');
const cancelNote = document.getElementById('cancelNote');
const cancelNo = document.getElementById('cancelNo');
const cancelYes = document.getElementById('cancelYes');

cancelReason.addEventListener('change', ()=>{
  const v = String(cancelReason.value||'');
  cancelNote.style.display = (v && v.startsWith('Dig…ôr')) ? '' : 'none';
});

function openCancelModal(ride){
  return new Promise((resolve)=>{
    cancelInfo.innerHTML = `<b>#${ride.id}</b> ‚Ä¢ ${ride.pickup_text||''} ‚Üí ${ride.drop_text||''}`;
    cancelReason.value = '';
    cancelNote.value = '';
    cancelNote.style.display = 'none';
    cancelBack.style.display = 'flex';

    const close = (val)=>{
      cancelBack.style.display = 'none';
      cancelNo.onclick = null;
      cancelYes.onclick = null;
      resolve(val);
    };

    cancelNo.onclick = ()=> close(null);
    cancelBack.onclick = (e)=>{ if (e.target === cancelBack) close(null); };
    cancelYes.onclick = ()=>{
      const sel = String(cancelReason.value||'').trim();
      if (!sel) { alert('S…ôb…ôb se√ßin.'); return; }
      let text = sel;
      if (sel.startsWith('Dig…ôr')) {
        const note = String(cancelNote.value||'').trim();
        if (note) text = note;
      }
      close(text.slice(0,200));
    };
  });
}
</script>
</body>
</html>
