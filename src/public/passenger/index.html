<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PayTaksi - S…ôrni≈üin</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="../assets/common.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:14px}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:12px;margin:10px 0}
    input,button,select{width:100%;padding:10px;border-radius:12px;border:1px solid #d9d9d9;font-size:16px}
    button{border:none;background:#111;color:#fff}
    .row{display:grid;grid-template-columns:1fr;gap:8px}
    .muted{color:#666;font-size:13px}
    .list{margin-top:8px}
    .item{padding:8px;border:1px dashed #ddd;border-radius:12px;margin:6px 0}
  </style>
</head>
<body>
  <h2>PayTaksi üöï</h2>
  <div class="muted" id="who"></div>

  <div class="card">
    <div class="row">
      <button id="btnLoc">üìç M√∂vcud yerimi avtomatik tap</button>
      <div class="muted" id="locTxt">Yer: ‚Äî</div>

      <input id="pickupTxt" placeholder="M√∂vcud yeriniz (GPS il…ô avtomatik yazƒ±lacaq)" />
      <div class="list" id="pickupSuggestions"></div>

      <input id="dest" placeholder="Ged…ôc…ôyiniz yeri yazƒ±n (m…ôs: Nizami metro)" />
      <div class="list" id="suggestions"></div>

      <button id="btnCreate">üöï Sifari≈ü ver</button>
      <div class="muted" id="status">‚Äî</div>
    </div>
  </div>

  <div class="card">
    <b>Son sifari≈ül…ôr</b>
    <div class="list" id="rides"></div>
  </div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const who = document.getElementById('who');
const statusEl = document.getElementById('status');
const locTxt = document.getElementById('locTxt');
const ridesEl = document.getElementById('rides');
const suggEl = document.getElementById('suggestions');
const pickupInput = document.getElementById('pickupTxt');
const pickupSuggEl = document.getElementById('pickupSuggestions');

const u = tgUser();
who.textContent = u ? `ƒ∞stifad…ô√ßi: ${u.first_name || ''} (@${u.username||'-'})` : 'Local dev mode';

let pickup = null;
let drop = null;

document.getElementById('btnLoc').onclick = () => {
  setStatus(statusEl,'GPS sorƒüusu‚Ä¶');
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    pickup = { lat: pos.coords.latitude, lon: pos.coords.longitude, text: 'M…ônim yerim' };
    locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)} (tapƒ±lƒ±r‚Ä¶)`;

    // M√∂vcud yerin adƒ±nƒ± tap (reverse geocode)
    try{
      const url = new URL('/api/reverse', location.origin);
      url.searchParams.set('lat', pickup.lat);
      url.searchParams.set('lon', pickup.lon);
      const r = await fetch(url);
      const j = await r.json();
      if (j.ok && (j.name || j.display_name)){
        pickup.text = j.name || j.display_name;
        locTxt.textContent = `Yer: ${pickup.text}`;
        pickupInput.value = pickup.text;
      } else {
        locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)}`;
        pickupInput.value = '';
      }
    }catch(e){
      locTxt.textContent = `Yer: ${pickup.lat.toFixed(5)}, ${pickup.lon.toFixed(5)}`;
      pickupInput.value = '';
    }

    setStatus(statusEl,'Yer tapƒ±ldƒ± ‚úÖ');
  }, (err)=>{
    setStatus(statusEl,'GPS icaz…ôsi verilm…ôdi ‚ùå', false);
  }, { enableHighAccuracy:true, timeout:10000 });
};

// --- Autocomplete helper
async function loadSuggestions(q, listEl, onPick){
  if (!q || q.length < 3){ listEl.innerHTML=''; return; }
  try{
    const url = new URL('/api/places', location.origin);
    url.searchParams.set('q', q);
    if (pickup){ url.searchParams.set('lat', pickup.lat); url.searchParams.set('lon', pickup.lon); }
    const r = await fetch(url);
    const data = await r.json();
    listEl.innerHTML = '';
    (data.items||[]).forEach((it)=>{
      const div = document.createElement('div');
      div.className='item';
      div.textContent = it.title;
      div.onclick = ()=> onPick(it);
      listEl.appendChild(div);
    });
  }catch(e){ listEl.innerHTML=''; }
}

let tmrPick = null;
pickupInput.addEventListener('input', (e)=>{
  clearTimeout(tmrPick);
  const q = e.target.value.trim();
  tmrPick = setTimeout(()=>{
    loadSuggestions(q, pickupSuggEl, (it)=>{
      // Allow user to override pickup by selecting a nearby place
      pickup = { lat: it.lat, lon: it.lon, text: it.title };
      pickupInput.value = it.title;
      locTxt.textContent = `Yer: ${it.title}`;
      pickupSuggEl.innerHTML='';
    });
  }, 250);
});


let tmr = null;
document.getElementById('dest').addEventListener('input', (e)=>{
  clearTimeout(tmr);
  const q = e.target.value.trim();
  if (q.length < 3){ suggEl.innerHTML=''; drop=null; return; }
  tmr = setTimeout(async ()=>{
    loadSuggestions(q, suggEl, (it)=>{
      drop = { lat: it.lat, lon: it.lon, text: it.title };
      document.getElementById('dest').value = it.title;
      suggEl.innerHTML='';
    });
  }, 250);
});

document.getElementById('btnCreate').onclick = async ()=>{
  if (!pickup) return setStatus(statusEl,'∆èvv…ôlc…ô yerinizi tapƒ±n (GPS).', false);
  if (!drop) return setStatus(statusEl,'Ged…ôc…ôyiniz yeri se√ßin.', false);
  try{
    setStatus(statusEl,'Sifari≈ü yaradƒ±lƒ±r‚Ä¶');
    const data = await api('/api/passenger/create_ride',{method:'POST',body:{
      pickup_lat: pickup.lat, pickup_lon: pickup.lon, pickup_text: pickup.text,
      drop_lat: drop.lat, drop_lon: drop.lon, drop_text: drop.text
    }});
    setStatus(statusEl,`Sifari≈ü #${data.ride.id} yaradƒ±ldƒ±. T…ôxmini qiym…ôt: ${data.ride.fare} AZN (komissiya: ${data.ride.commission} AZN)`);
    await loadRides();
  }catch(e){
    setStatus(statusEl,'X…ôta: '+(e.data?.reason||e.data?.error||e.message), false);
  }
};

async function loadRides(){
  try{
    const data = await api('/api/passenger/my_rides');
    ridesEl.innerHTML='';
    (data.rides||[]).forEach((r)=>{
      const div = document.createElement('div');
      div.className='item';
      const drv = r.driver_id ? `S√ºr√ºc√º: ${r.driver_name || ''} (@${r.driver_username||'-'})` : 'S√ºr√ºc√º: ‚Äî';
      div.innerHTML = `<b>#${r.id}</b> ‚Ä¢ ${r.status}<br>
        ${r.pickup_text||''} ‚Üí ${r.drop_text||''}<br>
        M…ôsaf…ô: ${Number(r.distance_km).toFixed(2)} km ‚Ä¢ Qiym…ôt: ${r.fare} AZN<br>
        <span class="muted">${drv}</span>`;
      ridesEl.appendChild(div);
    });
    if (!data.rides?.length) ridesEl.innerHTML = '<div class="muted">H…ôl…ô sifari≈ü yoxdur.</div>';
  }catch(e){}
}
loadRides();
setInterval(loadRides, 4000);
</script>
</body>
</html>
