generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PASSENGER
  DRIVER
  ADMIN
}

enum DriverStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RideStatus {
  REQUESTED
  OFFERED
  ACCEPTED
  ARRIVED
  IN_RIDE
  COMPLETED
  CANCELED
}

model User {
  id            String   @id @default(cuid())
  telegramId    String?  @unique
  name          String?
  username      String?
  phone         String?
  role          UserRole @default(PASSENGER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  driverProfile DriverProfile?
  ridesAsPassenger Ride[] @relation("PassengerRides")
  ridesAsDriver    Ride[] @relation("DriverRides")
  topups         TopUpRequest[]
}

model AdminUser {
  id        String   @id @default(cuid())
  login     String   @unique
  passHash  String
  createdAt DateTime @default(now())
}

model DriverProfile {
  id            String       @id @default(cuid())
  userId        String       @unique
  status        DriverStatus @default(PENDING)
  carYear       Int
  carColor      String
  carModel      String?
  carPlate      String?
  balance       Float        @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user          User         @relation(fields: [userId], references: [id])
  documents     DriverDocument[]
  locations     DriverLocation[]
}

model DriverDocument {
  id        String   @id @default(cuid())
  driverId  String
  type      String   // id_front, id_back, dl_front, dl_back, tp_front, tp_back
  path      String
  createdAt DateTime @default(now())

  driver    DriverProfile @relation(fields: [driverId], references: [id])

  @@index([driverId])
}

model DriverLocation {
  id        String   @id @default(cuid())
  driverId  String
  lat       Float
  lng       Float
  heading   Float?
  speed     Float?
  createdAt DateTime @default(now())

  driver    DriverProfile @relation(fields: [driverId], references: [id])

  @@index([driverId, createdAt])
}

model Ride {
  id           String     @id @default(cuid())
  passengerId  String
  driverId     String?
  status       RideStatus @default(REQUESTED)

  pickupLat    Float
  pickupLng    Float
  pickupText   String?
  dropLat      Float
  dropLng      Float
  dropText     String?

  distanceKm   Float?
  fareAzN      Float?
  commissionAzN Float?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  passenger    User       @relation("PassengerRides", fields: [passengerId], references: [id])
  driver       User?      @relation("DriverRides", fields: [driverId], references: [id])

  @@index([passengerId, createdAt])
  @@index([driverId, createdAt])
}

model Setting {
  key   String @id
  value String
}

model TopUpRequest {
  id        String   @id @default(cuid())
  userId    String
  method    String   // card2card | m10
  amount    Float
  note      String?
  status    String   @default("PENDING") // PENDING/APPROVED/REJECTED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  @@index([userId, createdAt])
}
