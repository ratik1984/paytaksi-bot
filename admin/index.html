<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PayTaksi — Admin</title>
<script src="config.js"></script>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0d12;color:#e8eefc}
header{padding:12px 14px;background:#101525;position:sticky;top:0;z-index:5;border-bottom:1px solid #1f2a44}
h1{font-size:16px;margin:0}
.container{padding:12px 14px;max-width:980px;margin:0 auto}
.card{background:#101525;border:1px solid #1f2a44;border-radius:14px;padding:12px;margin:10px 0}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1;min-width:220px}
input,select,button,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #2a3960;background:#0b0d12;color:#e8eefc}
button{cursor:pointer;background:#2b5cff;border-color:#2b5cff}
button.secondary{background:#17203a;border-color:#2a3960}
small{opacity:.8}
#map{height:360px;border-radius:14px;overflow:hidden;border:1px solid #1f2a44}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#17203a;border:1px solid #2a3960;font-size:12px}
hr{border:none;border-top:1px solid #1f2a44;margin:10px 0}
</style>
</head>
<body>
<header>
  <h1>PayTaksi — Admin Panel</h1>
  <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
    <span class="badge" id="ov">Overview: -</span>
  </div>
</header>

<div class="container">
  <div class="card">
    <h3 style="margin:0 0 10px 0;font-size:14px">Settings</h3>
    <div class="row">
      <div><label>BASE_FARE</label><input id="BASE_FARE"/></div>
      <div><label>FREE_KM</label><input id="FREE_KM"/></div>
      <div><label>PER_KM</label><input id="PER_KM"/></div>
      <div><label>COMMISSION_RATE</label><input id="COMMISSION_RATE"/></div>
      <div><label>MIN_DRIVER_BALANCE</label><input id="MIN_DRIVER_BALANCE"/></div>
    </div>
    <button id="saveSettings">Yadda saxla</button>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;font-size:14px">Topups</h3>
    <button class="secondary" id="reloadTopups">Yenilə</button>
    <div id="topups" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;font-size:14px">Drivers</h3>
    <button class="secondary" id="reloadDrivers">Yenilə</button>
    <div id="drivers" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;font-size:14px">Trips</h3>
    <button class="secondary" id="reloadTrips">Yenilə</button>
    <div id="trips" style="margin-top:10px"></div>
  </div>

  <div class="card"><h3 style="margin:0 0 10px 0;font-size:14px">Log</h3>
    <div id="log" style="white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;font-size:12px;opacity:.9"></div>
  </div>
</div>

<script>
const cfg=window.APP_CONFIG;
const logEl=document.getElementById("log");
const log=(m)=>logEl.textContent=`[${new Date().toLocaleTimeString()}] ${m}\n`+logEl.textContent;

async function api(path, method="GET", body=null){
  const res=await fetch(cfg.BACKEND_BASE_URL+path,{
    method,
    headers:{"Content-Type":"application/json","x-api-key":cfg.API_KEY,"x-telegram-id":cfg.TELEGRAM_ADMIN_ID},
    body: body?JSON.stringify(body):null
  });
  const data=await res.json();
  if(!res.ok) throw new Error(data.error||"API error");
  return data;
}

function mkTable(rows, cols){
  const t=document.createElement("table");
  t.style.width="100%"; t.style.borderCollapse="collapse";
  const head=document.createElement("tr");
  cols.forEach(c=>{
    const th=document.createElement("th");
    th.textContent=c; th.style.textAlign="left"; th.style.padding="8px"; th.style.borderBottom="1px solid #1f2a44";
    head.appendChild(th);
  });
  t.appendChild(head);
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    cols.forEach(c=>{
      const td=document.createElement("td");
      td.textContent=(r[c]==null)?"":r[c];
      td.style.padding="8px"; td.style.borderBottom="1px solid #1f2a44";
      tr.appendChild(td);
    });
    t.appendChild(tr);
  });
  return t;
}

async function loadOverview(){
  const o=await api("/api/admin/overview");
  document.getElementById("ov").textContent=`Overview: trips=${o.trips} active=${o.active} onlineDrivers=${o.drivers_online}`;
}

async function loadSettings(){
  const s=await api("/api/admin/settings");
  ["BASE_FARE","FREE_KM","PER_KM","COMMISSION_RATE","MIN_DRIVER_BALANCE"].forEach(k=>{
    document.getElementById(k).value = s.settings[k] ?? "";
  });
}

document.getElementById("saveSettings").onclick=async ()=>{
  try{
    const payload={};
    ["BASE_FARE","FREE_KM","PER_KM","COMMISSION_RATE","MIN_DRIVER_BALANCE"].forEach(k=>payload[k]=document.getElementById(k).value);
    await api("/api/admin/settings","POST",payload);
    log("Settings saved");
    await loadOverview();
  }catch(e){alert(e.message);}
};

async function loadTopups(){
  const r=await api("/api/admin/topups");
  const box=document.getElementById("topups"); box.innerHTML="";
  box.appendChild(mkTable(r.topups.map(x=>({
    id:x.id,status:x.status,amount:x.amount,method:x.method,telegram_id:x.telegram_id,proof:x.proof_text||""
  })),["id","status","amount","method","telegram_id","proof"]));
  r.topups.filter(x=>x.status==="PENDING").forEach(x=>{
    const b=document.createElement("button");
    b.textContent="Approve "+x.id;
    b.style.marginTop="8px";
    b.onclick=async ()=>{
      await api("/api/admin/topups/approve","POST",{request_id:x.id});
      log("Approved "+x.id);
      await loadTopups(); await loadDrivers(); await loadOverview();
    };
    box.appendChild(b);
  });
}

async function loadDrivers(){
  const r=await api("/api/admin/drivers");
  const box=document.getElementById("drivers"); box.innerHTML="";
  box.appendChild(mkTable(r.drivers.map(x=>({
    id:x.id,tg:x.telegram_id,status:x.status,wallet:x.wallet_balance,rating:x.rating,reject:x.reject_count
  })),["id","tg","status","wallet","rating","reject"]));
}

async function loadTrips(){
  const r=await api("/api/admin/trips");
  const box=document.getElementById("trips"); box.innerHTML="";
  box.appendChild(mkTable(r.trips.map(x=>({
    id:x.id,status:x.status,passenger_tg:x.passenger_tg,driver_tg:x.driver_tg||"",fare_total:x.fare_total||"",commission:x.commission||""
  })),["id","status","passenger_tg","driver_tg","fare_total","commission"]));
}

document.getElementById("reloadTopups").onclick=()=>loadTopups().catch(e=>alert(e.message));
document.getElementById("reloadDrivers").onclick=()=>loadDrivers().catch(e=>alert(e.message));
document.getElementById("reloadTrips").onclick=()=>loadTrips().catch(e=>alert(e.message));

(async ()=>{
  try{
    await loadOverview(); await loadSettings(); await loadTopups(); await loadDrivers(); await loadTrips();
    log("Admin loaded");
  }catch(e){ log("Error "+e.message); alert(e.message); }
})();
</script>
</body></html>
