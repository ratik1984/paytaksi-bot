<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PayTaksi — Passenger</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="config.js"></script>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b0d12;color:#e8eefc}
header{padding:12px 14px;background:#101525;position:sticky;top:0;z-index:5;border-bottom:1px solid #1f2a44}
h1{font-size:16px;margin:0}
.container{padding:12px 14px;max-width:980px;margin:0 auto}
.card{background:#101525;border:1px solid #1f2a44;border-radius:14px;padding:12px;margin:10px 0}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1;min-width:220px}
input,select,button,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #2a3960;background:#0b0d12;color:#e8eefc}
button{cursor:pointer;background:#2b5cff;border-color:#2b5cff}
button.secondary{background:#17203a;border-color:#2a3960}
small{opacity:.8}
#map{height:360px;border-radius:14px;overflow:hidden;border:1px solid #1f2a44}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#17203a;border:1px solid #2a3960;font-size:12px}
hr{border:none;border-top:1px solid #1f2a44;margin:10px 0}
</style>
</head>
<body>
<header>
  <h1>PayTaksi — Sərnişin</h1>
  <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
    <span class="badge" id="who">…</span>
    <span class="badge" id="tripStatus">Status: -</span>
  </div>
</header>
<div class="container">
  <div class="card">
    <div class="row">
      <div><label>Pickup</label><input id="pickup" placeholder="GPS ilə seç"/></div>
      <div><label>Drop (ünvan yaz)</label><input id="drop" placeholder="Ünvan yaz"/>
        <div id="dropSug" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>
      </div>
    </div>
    <div class="row">
      <div><label>Ödəniş</label>
        <select id="pay"><option value="CASH">Nağd</option><option value="CARD">Kart</option></select>
      </div>
      <div><label>Təxmini km</label><input id="dist" type="number" step="0.1" value="5.0"/></div>
      <div><label>&nbsp;</label><button id="btnCreate">Sifariş et</button></div>
    </div>
    <button class="secondary" id="btnGps">GPS al (Pickup)</button>
    <div id="fareBox" class="badge" style="margin-top:10px">Təxmini: -</div>
  </div>
  <div class="card"><div id="map"></div></div>
  <div class="card"><h3 style="margin:0 0 10px 0;font-size:14px">Log</h3>
    <div id="log" style="white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;font-size:12px;opacity:.9"></div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const tg = window.Telegram?.WebApp; tg?.ready();
const cfg = window.APP_CONFIG;
const logEl=document.getElementById("log");
const log=(m)=>logEl.textContent=`[${new Date().toLocaleTimeString()}] ${m}\n`+logEl.textContent;

const me={ telegram_id:(tg?.initDataUnsafe?.user?.id||"0").toString() };
document.getElementById("who").textContent="TG: "+me.telegram_id;

const map=L.map('map').setView([40.4093,49.8671],12);
const token=cfg.MAPBOX_TOKEN;
const tileUrl=token?`https://api.mapbox.com/styles/v1/mapbox/streets-v12/tiles/{z}/{x}/{y}?access_token=${token}`:`https://tile.openstreetmap.org/{z}/{x}/{y}.png`;
L.tileLayer(tileUrl,{maxZoom:19}).addTo(map);
let pickupMarker, dropMarker;
let pickup={lat:null,lng:null,address:null};
let drop={lat:null,lng:null,address:null};
let currentTripId=null;

async function api(path, method="GET", body=null){
  const res=await fetch(cfg.BACKEND_BASE_URL+path,{
    method,
    headers:{"Content-Type":"application/json","x-api-key":cfg.API_KEY,"x-telegram-id":me.telegram_id},
    body: body?JSON.stringify(body):null
  });
  const data=await res.json();
  if(!res.ok) throw new Error(data.error||"API error");
  return data;
}

api("/api/register","POST",{role:"passenger"})
  .then(r=>log("Registered passenger user_id="+r.user.id))
  .catch(e=>log("Register error: "+e.message));

document.getElementById("drop").addEventListener("input",(e)=>{
  const q=e.target.value.trim(); const sug=document.getElementById("dropSug"); sug.innerHTML="";
  if(q.length<3) return;
  [q+" 1",q+" 2",q+" 3"].forEach(t=>{
    const b=document.createElement("button");
    b.className="secondary"; b.style.width="auto"; b.textContent=t;
    b.onclick=()=>{document.getElementById("drop").value=t; sug.innerHTML="";};
    sug.appendChild(b);
  });
});

map.on("click",(e)=>{
  if(pickup.lat==null){
    pickup={lat:e.latlng.lat,lng:e.latlng.lng,address:"Pickup (tap)"};
    if(pickupMarker) pickupMarker.remove();
    pickupMarker=L.marker([pickup.lat,pickup.lng]).addTo(map);
    log("Pickup set");
  }else{
    drop={lat:e.latlng.lat,lng:e.latlng.lng,address:"Drop (tap)"};
    if(dropMarker) dropMarker.remove();
    dropMarker=L.marker([drop.lat,drop.lng]).addTo(map);
    log("Drop set");
  }
});

document.getElementById("btnGps").onclick=()=>{
  if(!navigator.geolocation) return alert("GPS yoxdur");
  navigator.geolocation.getCurrentPosition((pos)=>{
    pickup={lat:pos.coords.latitude,lng:pos.coords.longitude,address:"GPS pickup"};
    if(pickupMarker) pickupMarker.remove();
    pickupMarker=L.marker([pickup.lat,pickup.lng]).addTo(map);
    map.setView([pickup.lat,pickup.lng],15);
    log("GPS pickup set");
  }, (err)=>alert(err.message), {enableHighAccuracy:true, timeout:8000});
};

document.getElementById("btnCreate").onclick=async ()=>{
  if(pickup.lat==null||drop.lat==null) return alert("Xəritədə pickup və drop seç!");
  const est=Number(document.getElementById("dist").value||0);
  const pay=document.getElementById("pay").value;
  try{
    const r=await api("/api/trips/create","POST",{
      pickup_lat:pickup.lat,pickup_lng:pickup.lng,pickup_address:pickup.address,
      drop_lat:drop.lat,drop_lng:drop.lng,drop_address:(document.getElementById("drop").value||drop.address),
      est_distance_km:est,payment_method:pay
    });
    currentTripId=r.trip_id;
    document.getElementById("tripStatus").textContent="Status: SEARCHING";
    document.getElementById("fareBox").textContent=`Təxmini: ${r.fare_est} AZN (Komissiya: ${r.commission_est} AZN)`;
    log("Trip created "+currentTripId+" offered="+r.offered_drivers);
  }catch(e){alert(e.message);}
};

const socket=io(cfg.BACKEND_BASE_URL,{transports:["websocket","polling"]});
socket.on("connect",()=>{ log("Socket connected"); socket.emit("identify",{telegram_id:me.telegram_id,role:"passenger"}); });
socket.on("identified",(d)=>log("Socket identified passenger user_id="+d.user.id));
socket.on("trip_update",(u)=>{
  if(!currentTripId||u.trip_id!==currentTripId) return;
  document.getElementById("tripStatus").textContent="Status: "+u.status;
  log("Trip update "+JSON.stringify(u));
});
</script>
</body></html>
